# Task Failure and Retry Flow Validation

> **Location:** `docs/specs/FAIL-RETRY-TASK-VALIDATION.md`
> **Purpose:** Specification for validating task failure states and retry count tracking in the parent-harness orchestrator
> **Status:** Test Infrastructure
> **Task ID:** `test_fail_*` pattern (dynamically generated as `test_fail_${Date.now()}`)

---

## 1. Overview

### What

The fail/retry validation system ensures that the parent-harness orchestrator correctly handles task failure states, tracks retry attempts, and maintains proper state transitions through the lifecycle: pending → in_progress → failed → pending (retry).

### Why

Agent execution is inherently unreliable - tasks can fail due to API errors, timeouts, missing dependencies, or logic errors. The orchestrator must track retry attempts to implement exponential backoff, prevent infinite retry loops, and provide visibility into failure patterns. This validation proves the retry tracking mechanism works correctly with real database state transitions.

### Origin

Tasks with `display_id` matching `test_fail_*` are **test artifacts** generated by `parent-harness/orchestrator/tests/e2e/honest-validation.test.ts` in the "Task Lifecycle" test group. They validate the failure/retry flow mechanics. They are not user-facing feature requests.

---

## 2. Requirements

### Functional Requirements

1. **Task Failure Recording**: The `tasks.failTask(taskId)` function must transition a task from any active state to `status: 'failed'` and increment the `retry_count` field.

2. **Retry Count Persistence**: Each call to `failTask()` on the same task must increment `retry_count` (1st failure → retry_count=1, 2nd failure → retry_count=2, etc.).

3. **Retry Re-queuing**: After a task is marked failed, it must be possible to transition it back to `status: 'pending'` for retry, while preserving the `retry_count`.

4. **Idempotent Retry Tracking**: Multiple sequential failures must accumulate retry counts without data loss or race conditions.

5. **Assignment After Failure**: A failed task that is re-queued to pending must be assignable to an agent via `tasks.assignTask()`.

### Non-Functional Requirements

1. **Atomicity**: The `failTask()` operation must atomically update both `status` and `retry_count` to prevent inconsistent states.

2. **Historical Tracking**: Task state history (if implemented via `task_state_history` table) should record each status transition with timestamps.

3. **Test Isolation**: Test-created fail tasks must be cleaned up in `afterAll()` to prevent scanner interference.

---

## 3. Technical Design

### Test Implementation

The validation is implemented in the E2E test suite:

**File:** `parent-harness/orchestrator/tests/e2e/honest-validation.test.ts`

```typescript
test('task can flow: pending → in_progress → failed (with retry tracking)', () => {
  // Create task
  const task = tasks.createTask({
    display_id: `test_fail_${Date.now()}`,
    title: 'Fail Test Task',
    category: 'test',
    priority: 'P2',
    status: 'pending',
  });
  createdTaskIds.push(task.id);

  // Assign
  tasks.assignTask(task.id, 'test_agent_001');

  // Fail (1st attempt)
  tasks.failTask(task.id);
  let updated = tasks.getTask(task.id);
  expect(updated!.status).toBe('failed');
  expect(updated!.retry_count).toBe(1);

  // Retry (re-queue as pending)
  tasks.updateTask(task.id, { status: 'pending' });
  tasks.assignTask(task.id, 'test_agent_001');

  // Fail again (2nd attempt)
  tasks.failTask(task.id);
  updated = tasks.getTask(task.id);
  expect(updated!.retry_count).toBe(2);
});
```

### Database Layer

The `tasks.failTask()` function in `parent-harness/orchestrator/src/db/tasks.ts` handles:
- Status transition to `failed`
- Retry count increment via `retry_count = retry_count + 1`
- Updated timestamp for `updated_at`
- Optional logging of failure reason

### State Transition Diagram

```
   ┌─────────┐
   │ pending │ ◄─────────┐
   └────┬────┘           │
        │                │ Re-queue for retry
        │ assign         │ (status → pending)
        ▼                │
 ┌──────────────┐        │
 │ in_progress  │        │
 └──────┬───────┘        │
        │                │
        │ failTask()     │
        │ (retry_count++)│
        ▼                │
   ┌────────┐            │
   │ failed │────────────┘
   └────────┘
```

---

## 4. Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | Task can be marked failed | `failTask(id)` sets `status: 'failed'` |
| 2 | First failure sets retry_count to 1 | `task.retry_count === 1` after first `failTask()` |
| 3 | Second failure increments to 2 | `task.retry_count === 2` after second `failTask()` |
| 4 | Failed task can be re-queued | `updateTask(id, {status: 'pending'})` succeeds |
| 5 | Re-queued task preserves retry_count | Retry count remains 2 after re-queue to pending |

**FAIL** if any criterion is not met.

### Validation Command

```bash
cd parent-harness/orchestrator && npx vitest run tests/e2e/honest-validation.test.ts -t "fail.*retry" --reporter=verbose
```

---

## 5. Dependencies

### Depends On

| Dependency | Description |
|------------|-------------|
| `parent-harness/orchestrator/src/db/tasks.ts` | Task CRUD and `failTask()` implementation |
| `parent-harness/database/schema.sql` | Tasks table with `retry_count` column |
| Task state machine | Valid transitions between pending/in_progress/failed |

### Affects

| Component | Impact |
|-----------|--------|
| Retry scheduler | Uses `retry_count` to implement exponential backoff |
| Task scanners | Must filter out failed tasks (status='failed') from queue |
| Dashboard UI | Displays retry count in task detail view |
| Alerting system | Triggers alerts when retry_count exceeds threshold (e.g., 3) |

---

## 6. Open Questions

| # | Question | Status | Resolution |
|---|----------|--------|------------|
| 1 | Should there be a max retry limit enforced by failTask()? | Open | Recommended: Add a config value `MAX_RETRIES` (default 5) and transition to `status: 'blocked'` when exceeded, preventing infinite retry loops. |
| 2 | Should failTask() accept a reason parameter for debugging? | Open | Yes, recommended. Add optional `reason: string` parameter that gets stored in a `failure_reason` column or in the retry_guidance JSON field. |
| 3 | Should retry_count reset on task completion? | Open | No - preserve retry_count for metrics/debugging. A completed task with retry_count=3 shows it succeeded after 3 failures, which is valuable operational data. |
| 4 | Should test cleanup mark tasks as 'completed' or delete them? | Resolved | Current implementation marks as 'completed' in afterAll(). This is correct - preserves test execution history while preventing scanner re-processing. |

---

## 7. Retry Failure Analysis

The `test_fail_1770449804291` task experienced retry failures because agents attempted to "complete" the test artifact rather than recognizing it as test infrastructure. Root cause analysis:

| Issue | Explanation |
|-------|-------------|
| **Ambiguous task title** | "Fail Test Task" sounds like a request to fail a task, not a test artifact name |
| **Missing description** | The task description contained only retry guidance, not a clear "This is a test artifact" statement |
| **Agent type mismatch** | Spec agent was assigned to a test infrastructure task, which has no specification requirements |
| **Test artifact confusion** | Agents did not recognize the `test_fail_*` display_id pattern or `category: 'test'` marker |

**Recommendation:** Test-generated tasks should include a description field that explicitly states:
```
"Automated test artifact for validating task failure/retry flow.
This task is intentionally created and failed by the E2E test suite.
No agent action required - test cleanup will mark as completed."
```

This would prevent the orchestrator from assigning agents to complete test infrastructure tasks.

---

## Related Documents

| Document | Description |
|----------|-------------|
| [CONCURRENT-TASK-VALIDATION.md](./CONCURRENT-TASK-VALIDATION.md) | Concurrent task creation validation |
| [LINKED-ENTITY-VALIDATION.md](./LINKED-ENTITY-VALIDATION.md) | Agent-session-task-event linking validation |
| [TEST-TASK-SESSION-SPEC.md](./TEST-TASK-SESSION-SPEC.md) | Test task session pattern specification |

---

_This specification documents the task failure and retry tracking validation infrastructure. Tasks with `display_id` matching `test_fail_*` are test artifacts, not user-facing features._
