# Linked Entity Data Integrity Validation

> **Location:** `docs/specs/LINKED-ENTITY-VALIDATION.md`
> **Purpose:** Specification for validating that agents, tasks, sessions, and events are properly linked in the orchestrator database
> **Status:** Test Infrastructure
> **Task ID:** `test_linked_1770449774551` (dynamically generated as `test_linked_${Date.now()}`)

---

## 1. Overview

### What

The linked entity validation system ensures that the parent-harness orchestrator correctly creates and maintains referential links between its four core entities: **agents**, **tasks**, **sessions**, and **observability events**. When an event is recorded, it must reference valid agent, session, and task records, and those references must be queryable via the events API.

### Why

The orchestrator's value depends on full traceability: every event must be attributable to a specific agent working on a specific task within a specific session. If these links break (orphaned events, dangling references, missing foreign keys), the system loses observability, debugging becomes impossible, and the dashboard displays incorrect data. This validation proves the linking works end-to-end with real database operations.

### Origin

Tasks with `display_id` matching `test_linked_*` are **test artifacts** generated by `parent-harness/orchestrator/tests/e2e/honest-validation.test.ts` in the "Data Integrity" test group. They validate the referential integrity chain: Agent → Session → Task → Event. They are not user-facing feature requests.

---

## 2. Requirements

### Functional Requirements

1. **Agent Creation/Retrieval**: The system must support creating an agent with `id`, `name`, and `type` fields via `agents.createAgent()`, and retrieving it via `agents.getAgent()`.

2. **Task Creation with Display ID**: The system must create a task with a unique `display_id`, `title`, `category`, and `priority`, returning a task object with a generated UUID `id`.

3. **Session Linking**: A session must be creatable that links a valid agent ID to a valid task ID via `sessions.createSession(agentId, taskId)`. Creating a session with invalid references must throw an error (foreign key constraint enforcement).

4. **Event Recording with Links**: The `eventHelpers.toolUse()` function must create an observability event that stores the `agent_id` and `session_id`, linking the event to the correct agent and session context.

5. **Event Querying by Agent**: The `getEvents({ agentId, limit })` function must return events filtered by agent ID, with the returned events containing the correct `agent_id` field matching the query parameter.

### Non-Functional Requirements

1. **Foreign Key Enforcement**: SQLite foreign key constraints must be active (`PRAGMA foreign_keys = ON`), ensuring sessions cannot reference non-existent agents or tasks.

2. **Test Isolation**: Test-created entities must be cleaned up in `afterAll()` to prevent scanner interference (the orchestrator's scanners would otherwise attempt to process orphaned test tasks).

3. **Idempotent Agent Creation**: The test must handle the case where `test_agent_001` already exists from a prior run by checking with `getAgent()` before calling `createAgent()`.

---

## 3. Technical Design

### Entity Relationship Chain

```
Agent (test_agent_001)
  └── Session (auto-generated UUID)
        ├── links to → Agent
        ├── links to → Task (test_linked_*)
        └── Event (tool:use)
              ├── agent_id → Agent
              └── session_id → Session
```

### Test Implementation

**File:** `parent-harness/orchestrator/tests/e2e/honest-validation.test.ts`

```typescript
test("events link to valid agents/tasks/sessions", () => {
  // 1. Create or retrieve agent
  let agent = agents.getAgent("test_agent_001");
  if (!agent) {
    agents.createAgent({
      id: "test_agent_001",
      name: "Test Agent",
      type: "build_agent",
    });
    agent = agents.getAgent("test_agent_001")!;
  }

  // 2. Create task with unique display_id
  const task = tasks.createTask({
    display_id: `test_linked_${Date.now()}`,
    title: "Linked Test Task",
    category: "test",
    priority: "P2",
  });
  createdTaskIds.push(task.id);

  // 3. Create session linking agent to task
  const session = sessions.createSession(agent.id, task.id);

  // 4. Create event with agent and session links
  eventHelpers.toolUse(agent.id, session.id, "test_tool", { test: true });

  // 5. Verify event references correct agent
  const recentEvents = getEvents({ agentId: agent.id, limit: 1 });
  expect(recentEvents.length).toBeGreaterThan(0);
  expect(recentEvents[0].agent_id).toBe(agent.id);
});
```

### Database Layer

| Module   | File                                             | Role                                                              |
| -------- | ------------------------------------------------ | ----------------------------------------------------------------- |
| Agents   | `parent-harness/orchestrator/src/db/agents.ts`   | `createAgent()`, `getAgent()`                                     |
| Tasks    | `parent-harness/orchestrator/src/db/tasks.ts`    | `createTask()` with UUID generation                               |
| Sessions | `parent-harness/orchestrator/src/db/sessions.ts` | `createSession(agentId, taskId)` with FK validation               |
| Events   | `parent-harness/orchestrator/src/db/events.ts`   | `events.toolUse()`, `getEvents()` with agent/session/task filters |

### Foreign Key Constraint Companion Test

The linked entity test works in tandem with the foreign key constraint test (same `Data Integrity` describe block):

```typescript
test("foreign key constraints work (session requires valid agent/task)", () => {
  expect(() => {
    sessions.createSession("nonexistent_agent_xyz", "nonexistent_task_xyz");
  }).toThrow();
});
```

This proves that the database rejects invalid references, which is the prerequisite for the linked entity test proving that valid references are maintained.

---

## 4. Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion                                     | How to Verify                                                                      |
| --- | --------------------------------------------- | ---------------------------------------------------------------------------------- |
| 1   | Agent exists or is created successfully       | `agents.getAgent('test_agent_001')` returns non-null                               |
| 2   | Task is created with unique display_id        | `task.id` is a valid UUID, `task.display_id` matches `test_linked_*`               |
| 3   | Session links agent to task                   | `sessions.createSession(agent.id, task.id)` returns a session object without error |
| 4   | Event is created with correct agent reference | `getEvents({ agentId: agent.id, limit: 1 })` returns at least 1 event              |
| 5   | Event agent_id matches the creating agent     | `recentEvents[0].agent_id === agent.id`                                            |
| 6   | Foreign key constraints are enforced          | `sessions.createSession('nonexistent', 'nonexistent')` throws                      |
| 7   | Test cleanup completes                        | All created task IDs are marked `completed` in `afterAll()`                        |

**FAIL** if any criterion is not met.

### Validation Command

```bash
cd parent-harness/orchestrator && npx vitest run tests/e2e/honest-validation.test.ts --reporter=verbose 2>&1 | grep -A5 "Data Integrity"
```

---

## 5. Dependencies

### Depends On

| Dependency                                       | Description                                                     |
| ------------------------------------------------ | --------------------------------------------------------------- |
| `parent-harness/orchestrator/src/db/agents.ts`   | Agent CRUD operations                                           |
| `parent-harness/orchestrator/src/db/tasks.ts`    | Task CRUD operations                                            |
| `parent-harness/orchestrator/src/db/sessions.ts` | Session creation with FK constraints                            |
| `parent-harness/orchestrator/src/db/events.ts`   | Event recording and querying                                    |
| `parent-harness/database/schema.sql`             | Schema for agents, tasks, sessions, observability_events tables |
| SQLite FK pragma                                 | `PRAGMA foreign_keys = ON` for constraint enforcement           |
| Vitest                                           | Test framework                                                  |

### Affects

| Component              | Impact                                                                                              |
| ---------------------- | --------------------------------------------------------------------------------------------------- |
| Dashboard event views  | Validates that events displayed in the dashboard have valid agent/task/session links                |
| Observability pipeline | Validates the core data model that all monitoring and alerting depends on                           |
| Agent spawner          | Validates that spawned agent sessions correctly link to assigned tasks                              |
| Crown agent / SIA      | Validates that system investigation events can be traced back to their originating agents and tasks |

---

## 6. Open Questions

| #   | Question                                                                                            | Status   | Resolution                                                                                                                                                                         |
| --- | --------------------------------------------------------------------------------------------------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Should event session_id linkage also be verified?                                                   | Open     | The current test only asserts `agent_id` on the returned event. Asserting `session_id` matches the created session would strengthen the validation.                                |
| 2   | Should task_id be verified on events?                                                               | Open     | Events created via `eventHelpers.toolUse()` receive `agent_id` and `session_id` but task_id linkage is indirect (through the session). Consider adding a direct task_id assertion. |
| 3   | Should test tasks use a dedicated `test` status instead of being set to `completed` during cleanup? | Resolved | No - marking as `completed` is sufficient to prevent scanners from picking them up. A dedicated test status would require schema changes for minimal benefit.                      |

---

## 7. Retry Failure Analysis

The `test_linked_1770449774551` task was generated as part of the E2E honest-validation test suite's "Data Integrity" test group. When this task appears in the orchestrator's task queue, it is a **test artifact** that should not be assigned to agents for execution.

| Issue                                        | Explanation                                                                                                                                |
| -------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| **Test artifact misidentified as work item** | The task has `category: 'test'` but the orchestrator's scanners may still pick it up if cleanup fails                                      |
| **Retry guidance is generic**                | "Analyze the error carefully and try a different approach" provides no actionable context because this is a test artifact, not a real task |
| **Agent rotation ineffective**               | Assigning spec/build/qa agents to a test artifact produces no useful output                                                                |

**Recommendation:** Test-generated tasks with `display_id` matching `test_linked_*` should be excluded from the scanner's pending task query, or the `afterAll()` cleanup should delete (not just complete) test tasks to prevent any scanner interaction.

---

## Related Documents

| Document                                                         | Description                                            |
| ---------------------------------------------------------------- | ------------------------------------------------------ |
| [CONCURRENT-TASK-VALIDATION.md](./CONCURRENT-TASK-VALIDATION.md) | Companion spec for concurrent task creation validation |
| [task-example-reference.md](./task-example-reference.md)         | Canonical task format reference                        |
| [observability/SPEC.md](./observability/SPEC.md)                 | Observability event schema and design                  |
| [E2E-SCENARIOS-CORE.md](./E2E-SCENARIOS-CORE.md)                 | Core E2E scenario definitions                          |

---

_This specification documents the linked entity data integrity validation infrastructure. Tasks with `display_id` matching `test_linked_\*` are test artifacts, not user-facing features.\_
