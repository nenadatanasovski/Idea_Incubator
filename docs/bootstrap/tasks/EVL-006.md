# EVL-006: Evaluation Caching

---

## Metadata

| Field          | Value                 |
| -------------- | --------------------- |
| **Phase**      | 4 - Evaluation System |
| **Depends On** | EVL-004               |
| **Blocks**     | None                  |
| **Priority**   | P4                    |
| **Owner**      | Human + Claude Code   |

---

## Summary

Implement caching for evaluation results to avoid re-running expensive Claude API calls when the underlying idea hasn't changed. Cache invalidation triggers when idea artifacts are modified.

---

## Context

### Why Caching?

| Benefit            | Impact                          |
| ------------------ | ------------------------------- |
| **Cost Reduction** | Avoid redundant API calls       |
| **Speed**          | Return cached results instantly |
| **Consistency**    | Same idea = same scores         |

### Cache Invalidation Triggers

| Trigger           | Action                       |
| ----------------- | ---------------------------- |
| Artifact modified | Invalidate affected criteria |
| Profile updated   | Invalidate Fit scores        |
| Force refresh     | User requests re-evaluation  |
| TTL expired       | Invalidate after 7 days      |

### Cache Key Structure

```
evaluation:{ideaSlug}:{contentHash}:{evaluationType}
```

---

## Requirements

1. **Cache Storage**:
   - Store evaluation results with idea
   - Include content hash for invalidation
   - Support partial caching (per category)

2. **Hash Calculation**:
   - Hash relevant artifacts
   - Include profile in hash (for Fit)
   - Detect changes efficiently

3. **Cache Management**:
   - Automatic invalidation on changes
   - Manual invalidation option
   - Cache statistics reporting

4. **Partial Re-evaluation**:
   - Only re-run changed categories
   - Merge with cached results
   - Track staleness

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion             | How to Verify                   |
| --- | --------------------- | ------------------------------- |
| 1   | Results cached        | Second run is instant           |
| 2   | Invalidation works    | Modify artifact, verify re-eval |
| 3   | Partial caching works | Only changed categories re-run  |
| 4   | Force refresh works   | `--force` flag triggers re-eval |

**FAIL** if any criterion is not met.

---

## Output Files

```
utils/evaluation-cache.ts                  <- Cache implementation
users/{user}/ideas/{idea}/.cache/          <- Cache storage
tests/unit/evaluation-cache.test.ts
```

---

## Code Template

```typescript
// utils/evaluation-cache.ts

interface CachedEvaluation {
  hash: string;
  timestamp: string;
  result: EvaluationResult;
  categoryHashes: Record<string, string>;
}

export class EvaluationCache {
  private cachePath(ideaSlug: string): string {
    return `users/${userSlug}/ideas/${ideaSlug}/.cache/evaluation.json`;
  }

  async get(
    userSlug: string,
    ideaSlug: string,
    currentHash: string,
  ): Promise<CachedEvaluation | null> {
    const cached = await this.load(userSlug, ideaSlug);
    if (!cached) return null;

    // Check if still valid
    if (cached.hash !== currentHash) return null;
    if (this.isExpired(cached.timestamp)) return null;

    return cached;
  }

  async set(
    userSlug: string,
    ideaSlug: string,
    result: EvaluationResult,
    hash: string,
  ): Promise<void> {
    const cached: CachedEvaluation = {
      hash,
      timestamp: new Date().toISOString(),
      result,
      categoryHashes: this.calculateCategoryHashes(result),
    };
    await this.save(userSlug, ideaSlug, cached);
  }

  calculateHash(ideaContext: IdeaContext): string {
    const content = JSON.stringify({
      readme: ideaContext.readme,
      brief: ideaContext.brief,
      // ... other artifacts
    });
    return crypto.createHash("md5").update(content).digest("hex");
  }
}
```

---

## Validation

```bash
# Run cache tests
npm test -- tests/unit/evaluation-cache.test.ts

# First evaluation (slow)
time npm run evaluate test-idea

# Second evaluation (fast, cached)
time npm run evaluate test-idea

# Force refresh
npm run evaluate test-idea -- --force

# Modify artifact and re-run
echo "updated" >> users/default/ideas/test-idea/README.md
npm run evaluate test-idea  # Should re-evaluate
```

---

## Next Steps

After completing: Evaluation System is feature complete. Proceed with Validation Agent (VAL-\*).
