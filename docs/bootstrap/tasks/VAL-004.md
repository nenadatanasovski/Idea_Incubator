# VAL-004: Test Runner Integration

---

## Metadata

| Field          | Value                |
| -------------- | -------------------- |
| **Phase**      | 8 - Validation Agent |
| **Depends On** | VAL-003              |
| **Blocks**     | VAL-005              |
| **Priority**   | P1                   |
| **Owner**      | Human + Claude Code  |

---

## Summary

Integrate Vitest test runner as a validator. The test runner executes unit and integration tests and reports results in a structured format that the Validation Agent can aggregate.

---

## Context

### Test Runner Responsibilities

| Responsibility | Implementation            |
| -------------- | ------------------------- |
| Run tests      | Execute `vitest run`      |
| Parse results  | Read JSON reporter output |
| Report status  | Pass/fail with details    |
| Track duration | Per-test timing           |

### Output Format

```typescript
interface TestRunResult {
  passed: number;
  failed: number;
  skipped: number;
  duration: number;
  failures: TestFailure[];
}

interface TestFailure {
  test: string;
  file: string;
  error: string;
  stack?: string;
}
```

---

## Requirements

1. **Test Execution**:
   - Run Vitest with JSON reporter
   - Support filtering by pattern
   - Handle test timeouts

2. **Result Parsing**:
   - Parse Vitest JSON output
   - Extract pass/fail counts
   - Capture failure details

3. **Error Handling**:
   - Graceful handling of no tests
   - Clear error messages for failures
   - Timeout handling

4. **Integration**:
   - Register as validator
   - Support level configuration
   - Report to aggregator

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion         | How to Verify                   |
| --- | ----------------- | ------------------------------- |
| 1   | Tests execute     | Run validator, see test output  |
| 2   | Results parsed    | Check structured result         |
| 3   | Failures captured | Intentionally fail test, verify |
| 4   | Timeouts work     | Test with slow test             |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/validation/validators/test-runner.ts
```

---

## Code Template

```typescript
// agents/validation/validators/test-runner.ts

import { spawn } from "child_process";
import { ValidatorResult, Validator } from "../types";

export class TestRunnerValidator implements Validator {
  name = "test-runner";

  async validate(options: ValidatorOptions): Promise<ValidatorResult> {
    const startTime = Date.now();

    try {
      const result = await this.runVitest(options);
      const duration = Date.now() - startTime;

      return {
        validator: this.name,
        passed: result.failed === 0,
        duration,
        details: {
          passed: result.passed,
          failed: result.failed,
          skipped: result.skipped,
          failures: result.failures,
        },
      };
    } catch (error) {
      return {
        validator: this.name,
        passed: false,
        duration: Date.now() - startTime,
        error: error.message,
      };
    }
  }

  private async runVitest(options: ValidatorOptions): Promise<TestRunResult> {
    return new Promise((resolve, reject) => {
      const args = ["vitest", "run", "--reporter=json"];

      if (options.pattern) {
        args.push(options.pattern);
      }

      const proc = spawn("npx", args, { timeout: options.timeout });

      let output = "";
      proc.stdout.on("data", (data) => (output += data));

      proc.on("close", (code) => {
        try {
          const result = JSON.parse(output);
          resolve(this.parseResult(result));
        } catch {
          reject(new Error(`Failed to parse test results: ${output}`));
        }
      });
    });
  }
}
```

---

## Validation

```bash
# Run test validator
npm run validate -- --validator test-runner

# Test with specific pattern
npm run validate -- --validator test-runner --pattern "unit"

# Verify failure capture
# Temporarily break a test, run validator, check output
```

---

## Next Steps

After completing: Implement coverage analyzer (VAL-005).
