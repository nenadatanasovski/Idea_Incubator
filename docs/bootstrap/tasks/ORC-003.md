# ORC-003: Question Queue System

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 3 - Orchestration |
| **Depends On** | ORC-001, QUE-001 |
| **Blocks** | WEB-003 |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Orchestrate question flow between agents and users, managing blocking and non-blocking questions.

---

## Requirements

1. **Question Flow**:
   - Agent submits question to queue
   - System calculates priority
   - Notifies user via appropriate channel
   - Routes answer back to agent

2. **Blocking Management**:
   - Block agent on BLOCKING questions
   - Track which agent is waiting
   - Resume agent when answered

3. **Non-Blocking Flow**:
   - Continue with defaults
   - Queue for later review
   - Apply answer retroactively if possible

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | File exists | `test -f server/orchestration/question-queue.ts` returns 0 |
| 2 | Exports QuestionQueue | `grep -q "export class QuestionQueue" server/orchestration/question-queue.ts` returns 0 |
| 3 | Has submitQuestion | `grep -q "submitQuestion(" server/orchestration/question-queue.ts` returns 0 |
| 4 | Has processAnswer | `grep -q "processAnswer(" server/orchestration/question-queue.ts` returns 0 |
| 5 | Handles blocking | `grep -q "blocking\|BLOCKING" server/orchestration/question-queue.ts` returns 0 |
| 6 | Notifies users | `grep -q "notify" server/orchestration/question-queue.ts` returns 0 |
| 7 | TypeScript compiles | `npx tsc --noEmit server/orchestration/question-queue.ts` returns 0 |
| 8 | Integration test | Manual: agent asks question, user answers, agent resumes |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/orchestration/
└── question-queue.ts
```

---

## Code Template

```typescript
// server/orchestration/question-queue.ts

export interface SubmitOptions {
  agentId: string;
  type: QuestionType;
  content: string;
  options?: string[];
  defaultAnswer?: string;
  context?: unknown;
}

export interface QuestionResult {
  questionId: string;
  answer?: string;
  usedDefault: boolean;
}

export class QuestionQueue {
  constructor(
    private eventBus: EventBus,
    private db: Database,
    private notifier: Notifier
  ) {}

  async submitQuestion(options: SubmitOptions): Promise<QuestionResult> {
    // 1. Store question
    // 2. Calculate priority
    // 3. Notify user
    // 4. If blocking, wait for answer
    // 5. Return result
  }

  async processAnswer(questionId: string, answer: string): Promise<void> {
    // 1. Store answer
    // 2. Notify waiting agent
  }
}
```

---

## Validation

```bash
npx tsc --noEmit server/orchestration/question-queue.ts
# Manual: full flow test
```
