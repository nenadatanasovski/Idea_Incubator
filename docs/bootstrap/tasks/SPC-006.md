# SPC-006: Gotcha Injector (Hardcoded)

---

## Metadata

| Field          | Value                       |
| -------------- | --------------------------- |
| **Phase**      | 1 - Spec Agent              |
| **Depends On** | SPC-005                     |
| **Blocks**     | SPC-008                     |
| **Priority**   | P2                          |
| **Owner**      | Build Agent (after Phase 1) |

---

## Summary

Inject relevant gotchas into tasks based on file patterns. V0.1 uses hardcoded gotchas; Knowledge Base integration comes in v0.2.

---

## Requirements

1. **Gotcha Library**:
   - 20+ hardcoded gotchas covering common issues
   - Categorized by file pattern (_.sql, server/routes/_, etc.)
   - Categorized by action type (CREATE, UPDATE)

2. **Matching Logic**:
   - Match gotchas to tasks by file pattern
   - Match by action type
   - Prioritize by relevance

3. **Injection**:
   - Add matched gotchas to task's gotchas array
   - Limit to 3-5 most relevant per task
   - Include in code template comments

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion              | How to Verify                                                                             |
| --- | ---------------------- | ----------------------------------------------------------------------------------------- |
| 1   | File exists            | `test -f agents/specification/gotcha-injector.ts` returns 0                               |
| 2   | Exports GotchaInjector | `grep -q "export class GotchaInjector" agents/specification/gotcha-injector.ts` returns 0 |
| 3   | Has 20+ gotchas        | `grep -c "content:" agents/specification/gotcha-injector.ts` >= 20                        |
| 4   | Has inject method      | `grep -q "inject(" agents/specification/gotcha-injector.ts` returns 0                     |
| 5   | Has pattern matching   | `grep -q "filePattern" agents/specification/gotcha-injector.ts` returns 0                 |
| 6   | TypeScript compiles    | `npx tsc --noEmit agents/specification/gotcha-injector.ts` returns 0                      |
| 7   | Unit tests pass        | `npm test -- --grep "gotcha-injector"` passes                                             |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/specification/
└── gotcha-injector.ts
```

---

## Code Template

```typescript
// agents/specification/gotcha-injector.ts

export interface Gotcha {
  id: string;
  content: string;
  filePattern: string; // glob pattern
  actionType: "CREATE" | "UPDATE" | "BOTH";
  severity: "warning" | "critical";
}

const HARDCODED_GOTCHAS: Gotcha[] = [
  {
    id: "SQL-001",
    content: "Always use parameterized queries to prevent SQL injection",
    filePattern: "*.sql",
    actionType: "BOTH",
    severity: "critical",
  },
  {
    id: "API-001",
    content: "Add input validation middleware before route handlers",
    filePattern: "server/routes/*",
    actionType: "CREATE",
    severity: "warning",
  },
  // ... 18+ more
];

export class GotchaInjector {
  inject(tasks: AtomicTask[]): AtomicTask[] {
    // Match and inject gotchas into tasks
  }

  private matchGotchas(task: AtomicTask): Gotcha[] {
    // Find relevant gotchas by pattern
  }
}
```

---

## Validation

```bash
npx tsc --noEmit agents/specification/gotcha-injector.ts
npm test -- --grep "gotcha-injector"
```
