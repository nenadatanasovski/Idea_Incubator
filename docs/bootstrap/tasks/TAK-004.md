# TAK-004: Task Test Results Migration

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 1 - Database Schema |
| **Depends On** | TAK-001 |
| **Blocks** | TAK-015 (TestExecutor) |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Create the task_test_results table for tracking API and UI test execution results. Supports the three-level test framework (API, UI, regression).

---

## Requirements

1. **Create task_test_results table**:
   - task_id and test_case_id references
   - test_type: api, ui, regression
   - status: passed, failed, skipped, error
   - output and error text fields
   - duration_ms for timing
   - screenshot_path for UI test failures

2. **Create indexes**:
   - idx_test_task on task_id
   - idx_test_status on status

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | Migration file exists | `test -f database/migrations/053_task_test_results.sql` returns 0 |
| 2 | Has table | `grep -q "CREATE TABLE IF NOT EXISTS task_test_results" database/migrations/053_task_test_results.sql` returns 0 |
| 3 | Has test types | `grep -q "api.*ui.*regression" database/migrations/053_task_test_results.sql` returns 0 |
| 4 | Has screenshot path | `grep -q "screenshot_path" database/migrations/053_task_test_results.sql` returns 0 |
| 5 | Migration runs | `sqlite3 :memory: < database/migrations/053_task_test_results.sql && echo 'OK'` returns "OK" |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/migrations/
└── 053_task_test_results.sql
```

---

## Code Template

```sql
-- Migration 053: Task test results

CREATE TABLE IF NOT EXISTS task_test_results (
  id TEXT PRIMARY KEY,
  task_id TEXT NOT NULL,
  test_case_id TEXT NOT NULL,
  test_type TEXT NOT NULL CHECK (test_type IN ('api', 'ui', 'regression')),
  status TEXT NOT NULL CHECK (status IN ('passed', 'failed', 'skipped', 'error')),
  output TEXT,
  error TEXT,
  duration_ms INTEGER,
  screenshot_path TEXT,  -- For UI tests
  executed_at TEXT NOT NULL DEFAULT (datetime('now')),
  executed_by TEXT
);

CREATE INDEX IF NOT EXISTS idx_test_task ON task_test_results(task_id);
CREATE INDEX IF NOT EXISTS idx_test_status ON task_test_results(status);
```

---

## Validation

```bash
npm run migrate
sqlite3 database/ideas.db ".schema task_test_results"
```

---

## Next Steps

After completing: Create task_blocks table (TAK-005).
