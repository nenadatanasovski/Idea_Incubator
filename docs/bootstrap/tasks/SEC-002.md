# SEC-002: Session Management

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 5 - Security |
| **Depends On** | SEC-001 |
| **Blocks** | WSK-001 |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Implement secure session management for authenticated users.

---

## Requirements

1. **Session Storage**:
   - Sessions table with tokens
   - Expiration handling
   - Device/browser tracking

2. **Session Operations**:
   - Create session on login
   - Validate session on requests
   - Refresh session tokens
   - Revoke session on logout

3. **Security**:
   - Secure token generation
   - HttpOnly cookies
   - CSRF protection
   - Session fixation prevention

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | Session module exists | `test -f server/auth/session.ts` returns 0 |
| 2 | Has createSession | `grep -q "createSession" server/auth/session.ts` returns 0 |
| 3 | Has validateSession | `grep -q "validateSession" server/auth/session.ts` returns 0 |
| 4 | Has revokeSession | `grep -q "revokeSession" server/auth/session.ts` returns 0 |
| 5 | Sessions table exists | `sqlite3 database/ideas.db ".schema sessions"` shows table |
| 6 | Uses secure tokens | `grep -q "crypto\|uuid" server/auth/session.ts` returns 0 |
| 7 | TypeScript compiles | `npx tsc --noEmit server/auth/session.ts` returns 0 |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/auth/
└── session.ts

database/migrations/
└── 027_sessions.sql
```

---

## Code Template

```typescript
// server/auth/session.ts

import { randomUUID } from 'crypto';

export interface Session {
  id: string;
  userId: string;
  token: string;
  expiresAt: Date;
  createdAt: Date;
  userAgent?: string;
}

export async function createSession(userId: string, userAgent?: string): Promise<Session> {
  const token = randomUUID();
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // 7 days
  // Store session
}

export async function validateSession(token: string): Promise<Session | null> {
  // Check token, expiration
}

export async function revokeSession(token: string): Promise<void> {
  // Delete session
}
```

---

## Validation

```bash
npx tsc --noEmit server/auth/session.ts
npm run migrate
# Manual: login, verify session cookie, logout, verify revoked
```
