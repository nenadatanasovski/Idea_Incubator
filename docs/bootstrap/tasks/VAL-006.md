# VAL-006: Security Scanner

---

## Metadata

| Field          | Value                |
| -------------- | -------------------- |
| **Phase**      | 8 - Validation Agent |
| **Depends On** | VAL-003              |
| **Blocks**     | None                 |
| **Priority**   | P2                   |
| **Owner**      | Human + Claude Code  |

---

## Summary

Implement a security scanning validator that checks for common vulnerabilities, dependency issues, and security best practices. Required for RELEASE level validation.

---

## Context

### Security Checks

| Check                          | Tool/Method   | Severity |
| ------------------------------ | ------------- | -------- |
| **Dependency vulnerabilities** | npm audit     | High     |
| **Hardcoded secrets**          | grep patterns | Critical |
| **SQL injection patterns**     | AST analysis  | High     |
| **XSS vulnerabilities**        | Code patterns | High     |
| **Insecure configurations**    | Config check  | Medium   |

### Security Report Format

```typescript
interface SecurityReport {
  passed: boolean;
  vulnerabilities: Vulnerability[];
  secrets: SecretFinding[];
  patterns: PatternMatch[];
  summary: {
    critical: number;
    high: number;
    medium: number;
    low: number;
  };
}
```

---

## Requirements

1. **Dependency Scanning**:
   - Run `npm audit`
   - Parse vulnerability results
   - Flag high/critical issues

2. **Secret Detection**:
   - Scan for API keys, passwords
   - Check common patterns
   - Ignore false positives (.example files)

3. **Code Pattern Analysis**:
   - Check for SQL injection risks
   - Check for XSS vulnerabilities
   - Verify input validation

4. **Reporting**:
   - Severity classification
   - Location of issues
   - Remediation suggestions

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion            | How to Verify             |
| --- | -------------------- | ------------------------- |
| 1   | Dependencies scanned | npm audit runs            |
| 2   | Secrets checked      | Test with fake secret     |
| 3   | Patterns analyzed    | Test with vulnerable code |
| 4   | Report generated     | Check output format       |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/validation/validators/security-scanner.ts
```

---

## Code Template

```typescript
// agents/validation/validators/security-scanner.ts

import { spawn } from "child_process";
import { ValidatorResult, Validator } from "../types";

const SECRET_PATTERNS = [
  /api[_-]?key\s*[:=]\s*['"][^'"]{20,}['"]/gi,
  /password\s*[:=]\s*['"][^'"]+['"]/gi,
  /secret\s*[:=]\s*['"][^'"]{10,}['"]/gi,
  /token\s*[:=]\s*['"][^'"]{20,}['"]/gi,
];

const VULNERABILITY_PATTERNS = [
  { pattern: /\$\{.*\}.*query|query.*\$\{.*\}/g, type: "sql-injection" },
  { pattern: /innerHTML\s*=|dangerouslySetInnerHTML/g, type: "xss" },
  { pattern: /eval\s*\(|new Function\s*\(/g, type: "code-injection" },
];

export class SecurityScanner implements Validator {
  name = "security";

  async validate(options: ValidatorOptions): Promise<ValidatorResult> {
    const startTime = Date.now();

    try {
      // Run all security checks
      const [auditResult, secretsResult, patternsResult] = await Promise.all([
        this.runNpmAudit(),
        this.scanForSecrets(),
        this.scanForPatterns(),
      ]);

      const report = this.aggregateResults(
        auditResult,
        secretsResult,
        patternsResult,
      );

      // Fail on critical or high severity issues
      const passed = report.summary.critical === 0 && report.summary.high === 0;

      return {
        validator: this.name,
        passed,
        duration: Date.now() - startTime,
        details: report,
      };
    } catch (error) {
      return {
        validator: this.name,
        passed: false,
        duration: Date.now() - startTime,
        error: error.message,
      };
    }
  }

  private async runNpmAudit(): Promise<AuditResult> {
    return new Promise((resolve) => {
      const proc = spawn("npm", ["audit", "--json"]);
      let output = "";
      proc.stdout.on("data", (data) => (output += data));
      proc.on("close", () => {
        try {
          resolve(JSON.parse(output));
        } catch {
          resolve({ vulnerabilities: {} });
        }
      });
    });
  }

  private async scanForSecrets(): Promise<SecretFinding[]> {
    // Scan source files for hardcoded secrets
    // Exclude .example, .template, test files
  }

  private async scanForPatterns(): Promise<PatternMatch[]> {
    // Scan for vulnerable code patterns
  }
}
```

---

## Validation

```bash
# Run security validator
npm run validate -- --validator security

# Test secret detection
echo "API_KEY='sk-test123456789012345'" > test-secret.ts
npm run validate -- --validator security
rm test-secret.ts

# Check npm audit
npm audit --json | jq '.metadata.vulnerabilities'
```

---

## Next Steps

After completing: Validation Agent is feature complete. All validators integrated with validation levels.
