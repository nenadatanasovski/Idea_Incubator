# COM-016: Database Migrations (Communication Tables)

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 0 - Communication Core |
| **Depends On** | FND-002 (Database Core) |
| **Blocks** | COM-002, COM-003, COM-007, COM-011, COM-014 |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Create database migrations for all communication-related tables. This must run before any COM components can work.

---

## Tables Required

| Table | Purpose | Used By |
|-------|---------|---------|
| `telegram_bots` | Bot tokens and metadata | COM-002 |
| `telegram_chat_links` | User chat IDs per bot | COM-003 |
| `active_agents` | Registered agents and state | COM-014 |
| `questions` | Question queue | COM-006, COM-007, COM-011 |
| `question_answers` | Answer history | COM-007 |
| `notifications` | Notification log | COM-010 |
| `communication_health` | Health check history | COM-014 |

---

## Requirements

1. **Migration File**:
   - Single migration for all COM tables
   - Proper foreign keys where applicable
   - Indexes for common queries

2. **Idempotent**:
   - Can run multiple times safely
   - Uses `IF NOT EXISTS`

3. **Rollback Support**:
   - Down migration to drop tables
   - Preserves data integrity

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | Migration file exists | `test -f database/migrations/030_communication_tables.sql` returns 0 |
| 2 | Creates telegram_bots | `grep -q "CREATE TABLE.*telegram_bots" database/migrations/030_communication_tables.sql` returns 0 |
| 3 | Creates telegram_chat_links | `grep -q "CREATE TABLE.*telegram_chat_links" database/migrations/030_communication_tables.sql` returns 0 |
| 4 | Creates active_agents | `grep -q "CREATE TABLE.*active_agents" database/migrations/030_communication_tables.sql` returns 0 |
| 5 | Creates questions | `grep -q "CREATE TABLE.*questions" database/migrations/030_communication_tables.sql` returns 0 |
| 6 | Migration runs | `npm run migrate` succeeds |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/migrations/
└── 030_communication_tables.sql
```

---

## Migration SQL

```sql
-- database/migrations/030_communication_tables.sql
-- Communication Core Tables

-- ============================================
-- TELEGRAM BOTS
-- Stores bot tokens and metadata
-- ============================================
CREATE TABLE IF NOT EXISTS telegram_bots (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  agent_type TEXT NOT NULL UNIQUE,
  bot_username TEXT NOT NULL,
  bot_token TEXT NOT NULL,
  is_active INTEGER DEFAULT 1,
  last_poll_at TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_telegram_bots_agent_type ON telegram_bots(agent_type);

-- ============================================
-- TELEGRAM CHAT LINKS
-- Links user to chat IDs per bot
-- ============================================
CREATE TABLE IF NOT EXISTS telegram_chat_links (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  bot_agent_type TEXT NOT NULL,
  chat_id TEXT NOT NULL,
  phone_number TEXT,
  verified INTEGER DEFAULT 0,
  verification_code TEXT,
  verification_sent_at TEXT,
  verified_at TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, bot_agent_type)
);

CREATE INDEX IF NOT EXISTS idx_chat_links_user ON telegram_chat_links(user_id);
CREATE INDEX IF NOT EXISTS idx_chat_links_chat ON telegram_chat_links(chat_id);
CREATE INDEX IF NOT EXISTS idx_chat_links_verification ON telegram_chat_links(verification_code);

-- ============================================
-- ACTIVE AGENTS
-- Currently registered agents
-- ============================================
CREATE TABLE IF NOT EXISTS active_agents (
  agent_id TEXT PRIMARY KEY,
  agent_type TEXT NOT NULL,
  session_id TEXT,
  state TEXT NOT NULL DEFAULT 'REGISTERING',
  assigned_bot TEXT NOT NULL,
  registered_at TEXT NOT NULL,
  last_heartbeat TEXT NOT NULL,
  ack_received INTEGER DEFAULT 0,
  ack_received_at TEXT,
  capabilities TEXT, -- JSON
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_active_agents_state ON active_agents(state);
CREATE INDEX IF NOT EXISTS idx_active_agents_type ON active_agents(agent_type);
CREATE INDEX IF NOT EXISTS idx_active_agents_session ON active_agents(session_id);

-- ============================================
-- QUESTIONS
-- Question queue
-- ============================================
CREATE TABLE IF NOT EXISTS questions (
  id TEXT PRIMARY KEY,
  agent_id TEXT NOT NULL,
  session_id TEXT,
  type TEXT NOT NULL,
  content TEXT NOT NULL,
  options TEXT, -- JSON array
  context TEXT, -- JSON
  status TEXT NOT NULL DEFAULT 'pending',
  blocking INTEGER DEFAULT 0,
  timeout_ms INTEGER,
  default_answer TEXT,
  telegram_message_id TEXT,
  email_message_id TEXT,
  delivered_via TEXT,
  delivered_at TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (agent_id) REFERENCES active_agents(agent_id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_questions_agent ON questions(agent_id);
CREATE INDEX IF NOT EXISTS idx_questions_status ON questions(status);
CREATE INDEX IF NOT EXISTS idx_questions_type ON questions(type);
CREATE INDEX IF NOT EXISTS idx_questions_session ON questions(session_id);
CREATE INDEX IF NOT EXISTS idx_questions_blocking ON questions(blocking, status);

-- ============================================
-- QUESTION ANSWERS
-- Answer history
-- ============================================
CREATE TABLE IF NOT EXISTS question_answers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  question_id TEXT NOT NULL,
  answer_type TEXT NOT NULL, -- 'button', 'text', 'timeout', 'default'
  answer_value TEXT,
  answered_via TEXT, -- 'telegram', 'email', 'web'
  answered_at TEXT NOT NULL,
  raw_response TEXT, -- Full response for debugging
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (question_id) REFERENCES questions(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_answers_question ON question_answers(question_id);

-- ============================================
-- NOTIFICATIONS
-- Notification delivery log
-- ============================================
CREATE TABLE IF NOT EXISTS notifications (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  agent_id TEXT NOT NULL,
  agent_type TEXT NOT NULL,
  notification_type TEXT NOT NULL,
  content TEXT NOT NULL,
  channel TEXT NOT NULL, -- 'telegram', 'email'
  status TEXT NOT NULL, -- 'pending', 'delivered', 'failed'
  telegram_message_id TEXT,
  email_message_id TEXT,
  error_message TEXT,
  retry_count INTEGER DEFAULT 0,
  delivered_at TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_notifications_agent ON notifications(agent_id);
CREATE INDEX IF NOT EXISTS idx_notifications_status ON notifications(status);
CREATE INDEX IF NOT EXISTS idx_notifications_created ON notifications(created_at);

-- ============================================
-- COMMUNICATION HEALTH
-- Health check history
-- ============================================
CREATE TABLE IF NOT EXISTS communication_health (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  agent_id TEXT NOT NULL,
  check_type TEXT NOT NULL, -- 'heartbeat', 'handshake', 'delivery'
  status TEXT NOT NULL, -- 'ok', 'degraded', 'failed'
  latency_ms INTEGER,
  error_message TEXT,
  checked_at TEXT NOT NULL,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (agent_id) REFERENCES active_agents(agent_id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_health_agent ON communication_health(agent_id);
CREATE INDEX IF NOT EXISTS idx_health_checked ON communication_health(checked_at);

-- ============================================
-- AGENT STATES (for MON-002 summary)
-- Tracks agent status over time
-- ============================================
CREATE TABLE IF NOT EXISTS agent_states (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  agent_id TEXT NOT NULL,
  status TEXT NOT NULL, -- 'working', 'idle', 'blocked', 'error'
  current_task TEXT,
  last_activity TEXT NOT NULL,
  session_id TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_agent_states_agent ON agent_states(agent_id);
CREATE INDEX IF NOT EXISTS idx_agent_states_status ON agent_states(status);

-- ============================================
-- ACTIVITY LOG (for /summary command)
-- ============================================
CREATE TABLE IF NOT EXISTS activity_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  agent_id TEXT,
  type TEXT NOT NULL,
  description TEXT NOT NULL,
  metadata TEXT, -- JSON
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_activity_created ON activity_log(created_at);
CREATE INDEX IF NOT EXISTS idx_activity_agent ON activity_log(agent_id);

-- ============================================
-- DETECTED ISSUES (for MON-005)
-- ============================================
CREATE TABLE IF NOT EXISTS detected_issues (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  agent_id TEXT,
  session_id TEXT,
  type TEXT NOT NULL,
  severity TEXT NOT NULL, -- 'low', 'medium', 'high', 'critical'
  description TEXT NOT NULL,
  evidence TEXT, -- JSON
  resolved INTEGER DEFAULT 0,
  resolved_at TEXT,
  detected_at TEXT NOT NULL,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_issues_detected ON detected_issues(detected_at);
CREATE INDEX IF NOT EXISTS idx_issues_agent ON detected_issues(agent_id);
CREATE INDEX IF NOT EXISTS idx_issues_resolved ON detected_issues(resolved);

-- ============================================
-- TRIGGERS: Auto-update updated_at
-- ============================================
CREATE TRIGGER IF NOT EXISTS update_telegram_bots_timestamp
  AFTER UPDATE ON telegram_bots
  FOR EACH ROW
BEGIN
  UPDATE telegram_bots SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS update_chat_links_timestamp
  AFTER UPDATE ON telegram_chat_links
  FOR EACH ROW
BEGIN
  UPDATE telegram_chat_links SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS update_active_agents_timestamp
  AFTER UPDATE ON active_agents
  FOR EACH ROW
BEGIN
  UPDATE active_agents SET updated_at = CURRENT_TIMESTAMP WHERE agent_id = NEW.agent_id;
END;

CREATE TRIGGER IF NOT EXISTS update_questions_timestamp
  AFTER UPDATE ON questions
  FOR EACH ROW
BEGIN
  UPDATE questions SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS update_agent_states_timestamp
  AFTER UPDATE ON agent_states
  FOR EACH ROW
BEGIN
  UPDATE agent_states SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;
```

---

## Verification

```bash
# Run migration
npm run migrate

# Verify tables exist
sqlite3 database/ideas.db ".tables" | grep -E "telegram_bots|questions|active_agents"

# Check schema
sqlite3 database/ideas.db ".schema questions"
```

---

## Rollback (if needed)

```sql
-- database/migrations/030_communication_tables.down.sql

DROP TABLE IF EXISTS communication_health;
DROP TABLE IF EXISTS question_answers;
DROP TABLE IF EXISTS notifications;
DROP TABLE IF EXISTS questions;
DROP TABLE IF EXISTS active_agents;
DROP TABLE IF EXISTS telegram_chat_links;
DROP TABLE IF EXISTS telegram_bots;
DROP TABLE IF EXISTS agent_states;
DROP TABLE IF EXISTS activity_log;
DROP TABLE IF EXISTS detected_issues;
```
