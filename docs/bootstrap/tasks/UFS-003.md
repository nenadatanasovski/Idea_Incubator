# UFS-003: Update Artifact Store to Use Files

---

## Metadata

| Field          | Value                         |
| -------------- | ----------------------------- |
| **Phase**      | 2 - Unified File System       |
| **Depends On** | UFS-002                       |
| **Blocks**     | All agent artifact operations |
| **Priority**   | P1                            |
| **Owner**      | Human + Claude Code           |

---

## Summary

Refactor the UnifiedArtifactStore to read from and write to the file system instead of the database. Maintain the same API for backward compatibility while changing the underlying storage mechanism.

---

## Context

### Current vs New Implementation

| Aspect      | Current (Database) | New (File System) |
| ----------- | ------------------ | ----------------- |
| **Storage** | SQLite table       | Markdown files    |
| **Read**    | SQL query          | fs.readFile       |
| **Write**   | SQL insert/update  | fs.writeFile      |
| **List**    | SQL select         | fs.readdir        |
| **Delete**  | SQL delete         | fs.unlink         |

### API Compatibility

The external API should remain the same:

```typescript
interface ArtifactStore {
  get(
    userSlug: string,
    ideaSlug: string,
    type: string,
  ): Promise<Artifact | null>;
  save(
    userSlug: string,
    ideaSlug: string,
    type: string,
    content: string,
  ): Promise<void>;
  list(userSlug: string, ideaSlug: string): Promise<Artifact[]>;
  delete(userSlug: string, ideaSlug: string, type: string): Promise<void>;
}
```

---

## Requirements

1. **File-Based Get**:
   - Read markdown file from file system
   - Parse YAML frontmatter for metadata
   - Return artifact object with content

2. **File-Based Save**:
   - Write markdown file with frontmatter
   - Create parent directories if needed
   - Update modified timestamp in frontmatter

3. **File-Based List**:
   - Scan idea folder for markdown files
   - Map file names to artifact types
   - Return list of artifact metadata

4. **File-Based Delete**:
   - Remove file from file system
   - Handle missing files gracefully

5. **Backward Compatibility**:
   - Same function signatures
   - Same return types
   - Deprecation warnings for database calls

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion            | How to Verify                         |
| --- | -------------------- | ------------------------------------- |
| 1   | Get reads from files | Mock file system, verify read calls   |
| 2   | Save writes to files | Verify file content after save        |
| 3   | List scans directory | Compare list output with actual files |
| 4   | Existing tests pass  | Run full test suite                   |

**FAIL** if any criterion is not met.

---

## Output Files

```
utils/artifact-store.ts          <- Updated implementation
types/artifact.ts                <- Updated types (if needed)
tests/artifact-store.test.ts     <- Updated tests
```

---

## Code Template

```typescript
// utils/artifact-store.ts

import * as fs from "fs/promises";
import * as path from "path";
import matter from "gray-matter";
import { getFilePath, getIdeaPath, FileType } from "./folder-structure";

export class UnifiedArtifactStore {
  async get(
    userSlug: string,
    ideaSlug: string,
    type: FileType,
  ): Promise<Artifact | null> {
    const filePath = getFilePath(userSlug, ideaSlug, type);

    try {
      const content = await fs.readFile(filePath, "utf-8");
      const { data, content: body } = matter(content);

      return {
        id: `${userSlug}/${ideaSlug}/${type}`,
        type,
        content: body,
        metadata: data,
        createdAt: data.createdAt,
        updatedAt: data.updatedAt,
      };
    } catch (error) {
      if (error.code === "ENOENT") return null;
      throw error;
    }
  }

  async save(
    userSlug: string,
    ideaSlug: string,
    type: FileType,
    content: string,
    metadata?: Record<string, unknown>,
  ): Promise<void> {
    const filePath = getFilePath(userSlug, ideaSlug, type);

    // Ensure directory exists
    await fs.mkdir(path.dirname(filePath), { recursive: true });

    // Add frontmatter
    const fileContent = matter.stringify(content, {
      ...metadata,
      updatedAt: new Date().toISOString(),
    });

    await fs.writeFile(filePath, fileContent, "utf-8");
  }

  async list(userSlug: string, ideaSlug: string): Promise<ArtifactSummary[]> {
    const ideaPath = getIdeaPath(userSlug, ideaSlug);
    const artifacts: ArtifactSummary[] = [];

    // Recursively find all markdown files
    await this.scanDirectory(ideaPath, artifacts, ideaPath);

    return artifacts;
  }
}
```

---

## Validation

```bash
# Run artifact store tests
npm test -- tests/artifact-store.test.ts

# Integration test with actual files
npm test -- tests/integration/artifacts.test.ts

# Verify TypeScript
npx tsc --noEmit
```

---

## Next Steps

After completing: Create template system for idea folders (UFS-004).
