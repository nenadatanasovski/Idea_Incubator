# TAK-003: Task State History Migration

---

## Metadata

| Field          | Value                      |
| -------------- | -------------------------- |
| **Phase**      | 1 - Database Schema        |
| **Depends On** | TAK-001                    |
| **Blocks**     | TAK-012 (LifecycleManager) |
| **Priority**   | P1                         |
| **Owner**      | Build Agent                |

---

## Summary

Create the task_state_history table for audit trail of all task status transitions. Records who changed what, when, and why.

---

## Requirements

1. **Create task_state_history table**:
   - task_id reference
   - from_status and to_status for transition
   - reason for the transition
   - changed_by actor
   - changed_at timestamp

2. **Create indexes**:
   - idx_history_task on task_id
   - idx_history_time on changed_at

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion              | How to Verify                                                                                                      |
| --- | ---------------------- | ------------------------------------------------------------------------------------------------------------------ |
| 1   | Migration file exists  | `test -f database/migrations/052_task_state_history.sql` returns 0                                                 |
| 2   | Has table              | `grep -q "CREATE TABLE IF NOT EXISTS task_state_history" database/migrations/052_task_state_history.sql` returns 0 |
| 3   | Has transition columns | `grep -q "from_status.*to_status" database/migrations/052_task_state_history.sql` returns 0                        |
| 4   | Migration runs         | `sqlite3 :memory: < database/migrations/052_task_state_history.sql && echo 'OK'` returns "OK"                      |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/migrations/
└── 052_task_state_history.sql
```

---

## Code Template

```sql
-- Migration 052: Task state history

CREATE TABLE IF NOT EXISTS task_state_history (
  id TEXT PRIMARY KEY,
  task_id TEXT NOT NULL,
  from_status TEXT,
  to_status TEXT NOT NULL,
  reason TEXT,
  changed_by TEXT NOT NULL,
  changed_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_history_task ON task_state_history(task_id);
CREATE INDEX IF NOT EXISTS idx_history_time ON task_state_history(changed_at);
```

---

## Validation

```bash
npm run migrate
sqlite3 database/ideas.db ".schema task_state_history"
```

---

## Next Steps

After completing: Create task_test_results table (TAK-004).
