# TAK-002: Task Relationships Migration

---

## Metadata

| Field          | Value                       |
| -------------- | --------------------------- |
| **Phase**      | 1 - Database Schema         |
| **Depends On** | TAK-001                     |
| **Blocks**     | TAK-013 (DependencyManager) |
| **Priority**   | P1                          |
| **Owner**      | Build Agent                 |

---

## Summary

Create the task_relationships table for tracking dependencies and links between tasks. Supports 11 relationship types per the task-data-model.md specification.

---

## Context

### Relationship Types

| Type             | Description                              |
| ---------------- | ---------------------------------------- |
| `depends_on`     | Task cannot start until target completes |
| `blocks`         | Task blocks target from starting         |
| `related_to`     | Loose association                        |
| `duplicate_of`   | Same work, needs merge                   |
| `subtask_of`     | Parent-child hierarchy                   |
| `supersedes`     | Replaces an older task                   |
| `implements`     | Implements a requirement/spec            |
| `conflicts_with` | Cannot run in parallel                   |
| `enables`        | Completion enables target                |
| `inspired_by`    | Idea came from target                    |
| `tests`          | Tests the target task                    |

---

## Requirements

1. **Create task_relationships table**:
   - source_task_id and target_task_id (both required)
   - relationship_type with CHECK constraint for 11 types
   - strength field for similarity scores (REAL)
   - metadata as JSON for type-specific data
   - UNIQUE constraint on source+target+type

2. **Create indexes**:
   - idx_rel_source on source_task_id
   - idx_rel_target on target_task_id
   - idx_rel_type on relationship_type

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion                 | How to Verify                                                                                                                                                |
| --- | ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1   | Migration file exists     | `test -f database/migrations/051_task_relationships.sql` returns 0                                                                                           |
| 2   | Has table                 | `grep -q "CREATE TABLE IF NOT EXISTS task_relationships" database/migrations/051_task_relationships.sql` returns 0                                           |
| 3   | Has 11 relationship types | `grep -q "depends_on.*blocks.*related_to" database/migrations/051_task_relationships.sql` returns 0                                                          |
| 4   | Has unique constraint     | `grep -q "UNIQUE.*source_task_id.*target_task_id" database/migrations/051_task_relationships.sql` returns 0                                                  |
| 5   | Migration runs            | `sqlite3 :memory: < database/migrations/050_tasks_schema.sql && sqlite3 :memory: < database/migrations/051_task_relationships.sql && echo 'OK'` returns "OK" |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/migrations/
└── 051_task_relationships.sql
```

---

## Code Template

```sql
-- Migration 051: Task relationships
-- Supports 11 relationship types per task-data-model.md

CREATE TABLE IF NOT EXISTS task_relationships (
  id TEXT PRIMARY KEY,
  source_task_id TEXT NOT NULL,
  target_task_id TEXT NOT NULL,
  relationship_type TEXT NOT NULL CHECK (relationship_type IN
    ('depends_on', 'blocks', 'related_to', 'duplicate_of', 'subtask_of',
     'supersedes', 'implements', 'conflicts_with', 'enables', 'inspired_by', 'tests')),
  strength REAL,
  metadata TEXT,  -- JSON for type-specific data
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  created_by TEXT,
  UNIQUE(source_task_id, target_task_id, relationship_type)
);

CREATE INDEX IF NOT EXISTS idx_rel_source ON task_relationships(source_task_id);
CREATE INDEX IF NOT EXISTS idx_rel_target ON task_relationships(target_task_id);
CREATE INDEX IF NOT EXISTS idx_rel_type ON task_relationships(relationship_type);
```

---

## Gotchas

- Foreign keys need `PRAGMA foreign_keys = ON` to enforce
- The UNIQUE constraint prevents duplicate relationships

---

## Validation

```bash
npm run migrate
sqlite3 database/ideas.db ".schema task_relationships"
```

---

## Next Steps

After completing: Create task_state_history table (TAK-003).
