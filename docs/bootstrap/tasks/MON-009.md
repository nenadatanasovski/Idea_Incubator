# MON-009: Question Integration (ALERT/ESCALATION/APPROVAL)

---

## Metadata

| Field          | Value                    |
| -------------- | ------------------------ |
| **Phase**      | 2 - Monitoring Agent     |
| **Depends On** | MON-007, QUE-001         |
| **Blocks**     | None                     |
| **Priority**   | P1                       |
| **Owner**      | Human (then Build Agent) |

---

## Summary

Integrate Monitoring Agent with the Question Queue system, adding new question types for alerts, escalations, and approval requests.

---

## Requirements

1. **New Question Types**:
   - ALERT: FYI notification, no action required
   - ESCALATION: Tried to fix, need human help
   - APPROVAL: Want to take destructive action, need permission
   - DECISION: Multiple valid responses, human chooses

2. **Question Templates**:
   - APPROVAL_KILL: Request to kill agent
   - APPROVAL_EMERGENCY: Request emergency stop
   - ESCALATION_UNKNOWN: Unknown issue, need guidance
   - ALERT_UI_BUG: UI divergence detected
   - DECISION_CONFLICTING: Conflicting signals

3. **Timeout Handling**:
   - ALERT: No timeout (informational)
   - ESCALATION: 10 min timeout → emergency stop
   - APPROVAL: 5 min timeout → safe default (pause)
   - DECISION: 3 min timeout → wait

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion                     | How to Verify                                                                                     |
| --- | ----------------------------- | ------------------------------------------------------------------------------------------------- |
| 1   | File exists                   | `test -f agents/monitoring/question-integration.ts` returns 0                                     |
| 2   | Has 4 new question types      | `grep -c "ALERT\|ESCALATION\|APPROVAL\|DECISION" agents/monitoring/question-integration.ts` >= 4  |
| 3   | Has question templates        | `grep -q "APPROVAL_KILL\|ESCALATION_UNKNOWN" agents/monitoring/question-integration.ts` returns 0 |
| 4   | Has timeout handling          | `grep -q "timeout" agents/monitoring/question-integration.ts` returns 0                           |
| 5   | Integrates with QuestionQueue | `grep -q "QuestionQueue\|submitQuestion" agents/monitoring/question-integration.ts` returns 0     |
| 6   | TypeScript compiles           | `npx tsc --noEmit agents/monitoring/question-integration.ts` returns 0                            |
| 7   | Unit tests pass               | `npm test -- --grep "question-integration"` passes                                                |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/monitoring/
└── question-integration.ts
```

---

## Code Template

```typescript
// agents/monitoring/question-integration.ts

import { DetectedIssue } from "./detection-engine";
import { ResponseDecision, ResponseLevel } from "./response-escalator";

// Extended question types for Monitoring Agent
export type MonitoringQuestionType =
  | "ALERT" // FYI, no action required
  | "ESCALATION" // Tried to fix, need human help
  | "APPROVAL" // Want to take destructive action
  | "DECISION"; // Multiple valid responses

export interface MonitoringQuestion {
  type: MonitoringQuestionType;
  content: string;
  context: any;
  options: QuestionOption[];
  priority: number;
  timeout: number | null; // ms, null = no timeout
  timeoutAction: string | null; // Action to take on timeout
}

export interface QuestionOption {
  label: string;
  action: string;
  description?: string;
}

// Question templates
export const MONITORING_QUESTIONS = {
  APPROVAL_KILL: (
    issue: DetectedIssue,
    response: ResponseDecision,
  ): MonitoringQuestion => ({
    type: "APPROVAL",
    content: `Agent **${issue.agentId}** has failed repeatedly.

**Issue**: ${issue.description}
**Confidence**: ${(issue.confidence * 100).toFixed(0)}%
**Rationale**: ${response.rationale}

I want to **kill** this agent (requires manual restart).

Should I proceed?`,
    context: { issue, response },
    options: [
      {
        label: "Yes, kill it",
        action: "kill",
        description: "Agent will be terminated",
      },
      {
        label: "No, let it retry",
        action: "retry",
        description: "Agent continues with backoff",
      },
      {
        label: "Pause instead",
        action: "pause",
        description: "Agent pauses, can resume later",
      },
    ],
    priority: 95,
    timeout: 300_000, // 5 minutes
    timeoutAction: "pause", // Safe default
  }),

  APPROVAL_EMERGENCY: (reason: string): MonitoringQuestion => ({
    type: "APPROVAL",
    content: `**EMERGENCY STOP REQUESTED**

**Reason**: ${reason}

This will halt ALL agent work immediately.

Should I proceed?`,
    context: { reason },
    options: [
      {
        label: "Yes, emergency stop",
        action: "emergency",
        description: "All agents halt",
      },
      {
        label: "No, continue",
        action: "continue",
        description: "Agents continue working",
      },
    ],
    priority: 100, // Highest priority
    timeout: 60_000, // 1 minute
    timeoutAction: "emergency", // Fail-safe
  }),

  ESCALATION_UNKNOWN: (
    issue: DetectedIssue,
    attemptedActions: string[],
  ): MonitoringQuestion => ({
    type: "ESCALATION",
    content: `I detected an issue I don't understand:

**Agent**: ${issue.agentId}
**Issue**: ${issue.description}
**Evidence**: ${JSON.stringify(issue.evidence, null, 2)}

**I've tried**:
${attemptedActions.map((a) => `- ${a}`).join("\n")}

What should I do?`,
    context: { issue, attemptedActions },
    options: [
      { label: "Restart the agent", action: "restart" },
      { label: "Kill the agent", action: "kill" },
      { label: "Ignore this issue", action: "ignore" },
      { label: "I will handle it", action: "human_takeover" },
    ],
    priority: 90,
    timeout: 600_000, // 10 minutes
    timeoutAction: "pause",
  }),

  ALERT_UI_BUG: (divergence: any): MonitoringQuestion => ({
    type: "ALERT",
    content: `UI/Event Bus divergence detected:

**Event Bus says**: ${divergence.eventBusValue}
**Dashboard shows**: ${divergence.uiValue}
**Field**: ${divergence.field}
**Possible cause**: ${divergence.possibleCause}

This might be a UI bug. Logged for investigation.`,
    context: { divergence },
    options: [], // No action required for alerts
    priority: 30,
    timeout: null, // No timeout
    timeoutAction: null,
  }),

  DECISION_CONFLICTING: (
    issue: DetectedIssue,
    signals: any[],
  ): MonitoringQuestion => ({
    type: "DECISION",
    content: `Agent **${issue.agentId}** is showing conflicting signals:

${signals.map((s, i) => `**Signal ${i + 1}**: ${s.description}`).join("\n")}

I'm not confident enough to act autonomously.
What should I do?`,
    context: { issue, signals },
    options: [
      { label: "Trust Event Bus (agent is fine)", action: "trust_event_bus" },
      { label: "Trust UI (agent is stuck)", action: "trust_ui" },
      { label: "Wait and observe longer", action: "wait" },
      { label: "Restart to be safe", action: "restart" },
    ],
    priority: 70,
    timeout: 180_000, // 3 minutes
    timeoutAction: "wait",
  }),
};

export class MonitoringQuestionIntegration {
  private questionQueue: QuestionQueue;

  constructor(questionQueue: QuestionQueue) {
    this.questionQueue = questionQueue;
  }

  async submitAlert(divergence: any): Promise<void> {
    const question = MONITORING_QUESTIONS.ALERT_UI_BUG(divergence);
    await this.submit(question);
  }

  async submitApprovalKill(
    issue: DetectedIssue,
    response: ResponseDecision,
  ): Promise<ApprovalResult> {
    const question = MONITORING_QUESTIONS.APPROVAL_KILL(issue, response);
    return this.submitAndWait(question);
  }

  async submitEscalation(
    issue: DetectedIssue,
    attemptedActions: string[],
  ): Promise<EscalationResult> {
    const question = MONITORING_QUESTIONS.ESCALATION_UNKNOWN(
      issue,
      attemptedActions,
    );
    return this.submitAndWait(question);
  }

  async submitDecision(
    issue: DetectedIssue,
    signals: any[],
  ): Promise<DecisionResult> {
    const question = MONITORING_QUESTIONS.DECISION_CONFLICTING(issue, signals);
    return this.submitAndWait(question);
  }

  private async submit(question: MonitoringQuestion): Promise<string> {
    return this.questionQueue.submitQuestion({
      type: question.type,
      agentId: "monitoring-agent",
      content: question.content,
      options: question.options,
      context: question.context,
      priority: question.priority,
      blocking: question.type !== "ALERT",
      timeout: question.timeout,
      timeoutAction: question.timeoutAction,
    });
  }

  private async submitAndWait(question: MonitoringQuestion): Promise<any> {
    const questionId = await this.submit(question);

    if (question.timeout) {
      return Promise.race([
        this.questionQueue.waitForAnswer(questionId),
        this.createTimeout(question.timeout, question.timeoutAction),
      ]);
    }

    return this.questionQueue.waitForAnswer(questionId);
  }

  private createTimeout(ms: number, action: string | null): Promise<any> {
    return new Promise((resolve) => {
      setTimeout(() => {
        resolve({ action: action || "timeout", usedDefault: true });
      }, ms);
    });
  }
}

interface ApprovalResult {
  action: "kill" | "retry" | "pause";
  usedDefault: boolean;
}

interface EscalationResult {
  action: "restart" | "kill" | "ignore" | "human_takeover";
  usedDefault: boolean;
}

interface DecisionResult {
  action: "trust_event_bus" | "trust_ui" | "wait" | "restart";
  usedDefault: boolean;
}
```

---

## Validation

```bash
npx tsc --noEmit agents/monitoring/question-integration.ts
npm test -- --grep "question-integration"
```

---

## Database Schema Update

Add to QUE-001 (Question Queue schema):

```sql
-- Extend question types
-- Old: CHECK (type IN ('BLOCKING', 'CLARIFYING', 'CONFIRMING', 'PREFERENCE'))
-- New:
ALTER TABLE questions DROP CONSTRAINT questions_type_check;
ALTER TABLE questions ADD CONSTRAINT questions_type_check
  CHECK (type IN (
    'BLOCKING', 'CLARIFYING', 'CONFIRMING', 'PREFERENCE',
    'ALERT', 'ESCALATION', 'APPROVAL', 'DECISION'
  ));

-- Add timeout handling
ALTER TABLE questions ADD COLUMN timeout_ms INTEGER;
ALTER TABLE questions ADD COLUMN timeout_action TEXT;
```
