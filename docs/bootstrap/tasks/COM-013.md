# COM-013: Message Templates (Per Question Type)

---

## Metadata

| Field          | Value                  |
| -------------- | ---------------------- |
| **Phase**      | 0 - Communication Core |
| **Depends On** | COM-006                |
| **Blocks**     | None                   |
| **Priority**   | P2                     |
| **Owner**      | Build Agent            |

---

## Summary

Implement configurable message templates for each question type, allowing customization of how questions appear in Telegram and Email.

---

## Requirements

1. **Template Structure**:
   - Header (emoji + type label)
   - Body (question content)
   - Options section (if applicable)
   - Context section (for detailed format)
   - Footer (agent info, timestamps)

2. **Template Variables**:
   - `{{emoji}}` - Type-specific emoji
   - `{{type}}` - Question type label
   - `{{content}}` - Question content
   - `{{agentId}}` - Source agent
   - `{{options}}` - Formatted options list
   - `{{context}}` - Additional context
   - `{{timeout}}` - Time until timeout
   - `{{default}}` - Default action

3. **Format Levels**:
   - Concise: emoji + content only
   - Standard: emoji + content + options + agent
   - Detailed: Full context, evidence, rationale
   - Urgent: Prominent styling, repeated emoji

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion                | How to Verify                                                                                                           |
| --- | ------------------------ | ----------------------------------------------------------------------------------------------------------------------- |
| 1   | File exists              | `test -f server/communication/message-templates.ts` returns 0                                                           |
| 2   | Exports MessageTemplates | `grep -q "export.*MessageTemplates\|export class MessageTemplates" server/communication/message-templates.ts` returns 0 |
| 3   | Has format method        | `grep -q "format(" server/communication/message-templates.ts` returns 0                                                 |
| 4   | Has all question types   | `grep -c "ALERT\|BLOCKING\|APPROVAL\|ESCALATION" server/communication/message-templates.ts` >= 4                        |
| 5   | Has template variables   | `grep -q "{{.*}}\|\\${" server/communication/message-templates.ts` returns 0                                            |
| 6   | TypeScript compiles      | `npx tsc --noEmit server/communication/message-templates.ts` returns 0                                                  |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/communication/
â””â”€â”€ message-templates.ts
```

---

## Code Template

````typescript
// server/communication/message-templates.ts

type QuestionType =
  | "BLOCKING"
  | "CLARIFYING"
  | "CONFIRMING"
  | "PREFERENCE"
  | "ALERT"
  | "ESCALATION"
  | "APPROVAL"
  | "DECISION";

type FormatLevel = "concise" | "standard" | "detailed" | "urgent";

interface TemplateData {
  type: QuestionType;
  content: string;
  agentId: string;
  options?: { label: string; action: string; description?: string }[];
  context?: {
    rationale?: string;
    evidence?: any;
    history?: string[];
  };
  timeout?: number;
  defaultAction?: string;
}

interface Template {
  emoji: string;
  label: string;
  concise: string;
  standard: string;
  detailed: string;
  urgent: string;
}

const TEMPLATES: Record<QuestionType, Template> = {
  ALERT: {
    emoji: "â„¹ï¸",
    label: "Alert",
    concise: "{{emoji}} {{content}}",
    standard: "{{emoji}} *{{label}}*\n\n{{content}}\n\n_From: {{agentId}}_",
    detailed:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{context}}\n\n_From: {{agentId}}_",
    urgent: "{{emoji}} *{{label}}*\n\n{{content}}",
  },

  CLARIFYING: {
    emoji: "â“",
    label: "Clarifying Question",
    concise: "{{emoji}} {{content}}",
    standard:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}\n\n_From: {{agentId}}_",
    detailed:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}\n\n{{context}}\n\n_From: {{agentId}} | Timeout: {{timeout}}_",
    urgent: "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}",
  },

  CONFIRMING: {
    emoji: "âœ…",
    label: "Confirmation Needed",
    concise: "{{emoji}} {{content}}",
    standard:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}\n\n_From: {{agentId}}_",
    detailed:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}\n\n*Why I'm asking:*\n{{context}}\n\n_From: {{agentId}}_",
    urgent: "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}",
  },

  PREFERENCE: {
    emoji: "ðŸŽ¯",
    label: "Your Preference?",
    concise: "{{emoji}} {{content}}",
    standard:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}\n\n_From: {{agentId}}_",
    detailed:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}\n\n{{context}}\n\n_From: {{agentId}}_",
    urgent: "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}",
  },

  BLOCKING: {
    emoji: "ðŸ”´",
    label: "Blocking Question",
    concise: "{{emoji}} *BLOCKING*: {{content}}",
    standard:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}\n\nâ¸ï¸ _Agent blocked: {{agentId}}_",
    detailed:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}\n\n*Context:*\n{{context}}\n\nâ¸ï¸ _Agent blocked: {{agentId}}_\nðŸ’¡ _Default on timeout: {{default}}_",
    urgent:
      "ðŸ”´ðŸ”´ðŸ”´\n\n*BLOCKING QUESTION*\n\n{{content}}\n\n{{options}}\n\n_{{agentId}} is BLOCKED_\n\nðŸ”´ðŸ”´ðŸ”´",
  },

  DECISION: {
    emoji: "ðŸ¤”",
    label: "Decision Required",
    concise: "{{emoji}} {{content}}",
    standard:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}\n\n_From: {{agentId}}_",
    detailed:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}\n\n*Trade-offs:*\n{{context}}\n\n_From: {{agentId}} | Timeout: {{timeout}} â†’ {{default}}_",
    urgent:
      "{{emoji}}{{emoji}} *DECISION REQUIRED* {{emoji}}{{emoji}}\n\n{{content}}\n\n{{options}}",
  },

  ESCALATION: {
    emoji: "âš ï¸",
    label: "Escalation",
    concise: "{{emoji}} *ESCALATION*: {{content}}",
    standard:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n*What I've tried:*\n{{history}}\n\n{{options}}\n\n_From: {{agentId}}_",
    detailed:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n*What I've tried:*\n{{history}}\n\n*Evidence:*\n```\n{{evidence}}\n```\n\n{{options}}\n\n_From: {{agentId}}_",
    urgent: "âš ï¸âš ï¸âš ï¸\n\n*ESCALATION*\n\n{{content}}\n\n{{options}}\n\nâš ï¸âš ï¸âš ï¸",
  },

  APPROVAL: {
    emoji: "ðŸš¨",
    label: "Approval Required",
    concise: "{{emoji}} *APPROVAL*: {{content}}",
    standard:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n{{options}}\n\nâ›” _Requires your approval_\n_From: {{agentId}}_",
    detailed:
      "{{emoji}} *{{label}}*\n\n{{content}}\n\n*Rationale:*\n{{rationale}}\n\n*Evidence:*\n```\n{{evidence}}\n```\n\n{{options}}\n\nâ›” _This action requires your explicit approval_\nâ¸ï¸ _Session halted: {{agentId}}_",
    urgent:
      "ðŸš¨ðŸš¨ðŸš¨\n\n*APPROVAL REQUIRED*\n\n{{content}}\n\n{{options}}\n\n_Session HALTED pending approval_\n\nðŸš¨ðŸš¨ðŸš¨",
  },
};

export class MessageTemplates {
  format(data: TemplateData, level: FormatLevel = "standard"): string {
    const template = TEMPLATES[data.type];
    let message = template[level];

    // Replace variables
    message = message.replace(/{{emoji}}/g, template.emoji);
    message = message.replace(/{{label}}/g, template.label);
    message = message.replace(/{{content}}/g, data.content);
    message = message.replace(/{{agentId}}/g, data.agentId);

    // Format options
    if (data.options && data.options.length > 0) {
      const optionsText = this.formatOptions(data.options, level);
      message = message.replace(/{{options}}/g, optionsText);
    } else {
      message = message.replace(/{{options}}\n*/g, "");
    }

    // Format context
    if (data.context) {
      message = message.replace(
        /{{context}}/g,
        this.formatContext(data.context),
      );
      message = message.replace(/{{rationale}}/g, data.context.rationale || "");
      message = message.replace(
        /{{evidence}}/g,
        this.formatEvidence(data.context.evidence),
      );
      message = message.replace(
        /{{history}}/g,
        this.formatHistory(data.context.history),
      );
    } else {
      message = message.replace(/{{context}}\n*/g, "");
      message = message.replace(/{{rationale}}\n*/g, "");
      message = message.replace(/{{evidence}}\n*/g, "");
      message = message.replace(/{{history}}\n*/g, "");
    }

    // Format timeout
    if (data.timeout) {
      const timeoutStr = this.formatTimeout(data.timeout);
      message = message.replace(/{{timeout}}/g, timeoutStr);
    } else {
      message = message.replace(/{{timeout}}/g, "no timeout");
    }

    // Format default action
    message = message.replace(/{{default}}/g, data.defaultAction || "none");

    // Clean up any remaining empty placeholders
    message = message.replace(/\n{3,}/g, "\n\n");

    return message.trim();
  }

  getFormatLevel(type: QuestionType): FormatLevel {
    const levels: Record<QuestionType, FormatLevel> = {
      ALERT: "concise",
      CLARIFYING: "concise",
      CONFIRMING: "standard",
      PREFERENCE: "standard",
      BLOCKING: "standard",
      DECISION: "detailed",
      ESCALATION: "detailed",
      APPROVAL: "detailed",
    };
    return levels[type];
  }

  private formatOptions(
    options: { label: string; description?: string }[],
    level: FormatLevel,
  ): string {
    if (level === "concise") {
      return options.map((o) => `â€¢ ${o.label}`).join("\n");
    }

    if (level === "detailed") {
      return options
        .map((o) => {
          let text = `*${o.label}*`;
          if (o.description) {
            text += `\n${o.description}`;
          }
          return text;
        })
        .join("\n\n");
    }

    // Standard
    return (
      "*Options:*\n" +
      options
        .map((o) => {
          let text = `â€¢ ${o.label}`;
          if (o.description) {
            text += ` - _${o.description}_`;
          }
          return text;
        })
        .join("\n")
    );
  }

  private formatContext(context: any): string {
    if (context.rationale) {
      return `_${context.rationale}_`;
    }
    return "";
  }

  private formatEvidence(evidence: any): string {
    if (!evidence) return "";
    if (typeof evidence === "string") return evidence;
    return JSON.stringify(evidence, null, 2).slice(0, 500);
  }

  private formatHistory(history: string[] | undefined): string {
    if (!history || history.length === 0) return "";
    return history.map((h) => `â€¢ ${h}`).join("\n");
  }

  private formatTimeout(ms: number): string {
    const minutes = Math.floor(ms / 60000);
    if (minutes >= 60) {
      return `${Math.floor(minutes / 60)}h`;
    }
    return `${minutes}m`;
  }
}

// Export singleton for convenience
export const messageTemplates = new MessageTemplates();
````

---

## Usage

```typescript
import { messageTemplates } from "./message-templates";

const message = messageTemplates.format(
  {
    type: "APPROVAL",
    content: "I want to KILL agent build-agent-456.",
    agentId: "monitoring-agent",
    options: [
      { label: "Yes, kill it", description: "Agent will be terminated" },
      {
        label: "No, let it retry",
        description: "Agent continues with backoff",
      },
      { label: "Pause instead", description: "Agent pauses, can resume later" },
    ],
    context: {
      rationale: "Agent has failed 5 consecutive tasks with same error.",
      evidence: { error: "TypeError", count: 5 },
    },
  },
  "detailed",
);
```

---

## Validation

```bash
npx tsc --noEmit server/communication/message-templates.ts
npm test -- --grep "message-templates"
```
