# FND-002: Complete Pending Migrations (021-024)

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 1 - Foundation |
| **Depends On** | FND-001 |
| **Blocks** | All agent database operations |
| **Priority** | P1 |
| **Owner** | Human + Claude Code |

---

## Summary

Run all pending database migrations to bring the schema up to date. Migrations 021-024 include critical tables for agent operations, task tracking, and knowledge base storage.

---

## Context

### Migration Files

| Migration | Purpose | Status |
|-----------|---------|--------|
| 021_*.sql | Agent registration tables | Pending |
| 022_*.sql | Task queue tables | Pending |
| 023_*.sql | Knowledge base tables | Pending |
| 024_*.sql | Build execution tracking | Pending |

### Why Migrations Matter

| Reason | Impact |
|--------|--------|
| **Schema Sync** | Code expects tables to exist |
| **Data Integrity** | Foreign keys enforce relationships |
| **Feature Enablement** | New features require new tables |

---

## Requirements

1. **Review Migration Files**:
   - Read each migration file
   - Understand what tables/columns are created
   - Identify any dependencies between migrations

2. **Run Migrations in Order**:
   - Execute migrations sequentially (021 before 022, etc.)
   - Use `IF NOT EXISTS` to prevent duplicate errors
   - Log migration execution

3. **Verify Schema**:
   - Check all expected tables exist
   - Verify column types match expectations
   - Confirm foreign key constraints

4. **Update Migration Tracker**:
   - Record which migrations have run
   - Store migration timestamps

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | All migrations executed | No errors during `npm run migrate` |
| 2 | Tables exist | Query `.tables` shows new tables |
| 3 | Schema matches code | TypeScript types align with columns |
| 4 | No data loss | Existing data preserved |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/ideas.db                <- Updated database
database/migration-log.json      <- Migration execution log
```

---

## Manual Steps

### Step 1: Backup Database

```bash
cp database/ideas.db database/ideas.db.backup
```

### Step 2: Run Migrations

```bash
npm run migrate
```

### Step 3: Verify Tables

```bash
sqlite3 database/ideas.db ".tables"
```

---

## Validation

```bash
# Check migration status
npm run migrate:status

# Verify table count
sqlite3 database/ideas.db "SELECT COUNT(*) FROM sqlite_master WHERE type='table'"

# Test TypeScript compilation (types should match schema)
npx tsc --noEmit
```

---

## Rollback Procedure

If migrations fail:

```bash
# Restore from backup
cp database/ideas.db.backup database/ideas.db

# Or rollback specific migration
sqlite3 database/ideas.db < database/migrations/rollback_024.sql
```

---

## Next Steps

After completing: Proceed with API error handling standardization (FND-003).
