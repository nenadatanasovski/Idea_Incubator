# SPC-004: Claude Integration

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 1 - Spec Agent |
| **Depends On** | SPC-003 |
| **Blocks** | SPC-005, SPC-007 |
| **Priority** | P1 |
| **Owner** | Build Agent (after Phase 1) |

---

## Summary

Integrate Claude API for analyzing briefs and generating spec content. This is the "intelligence" behind Spec Agent.

---

## Requirements

1. **API Integration**:
   - Use Anthropic SDK (@anthropic-ai/sdk)
   - Handle rate limits with exponential backoff
   - Manage token budgets (< 100k per spec)
   - Support streaming for long generations

2. **Prompt Engineering**:
   - System prompt for spec generation
   - Brief analysis prompt
   - Task generation prompt
   - Architecture decision prompt

3. **Response Parsing**:
   - Extract structured data from responses
   - Handle markdown formatting
   - Parse YAML blocks from responses

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | File exists | `test -f agents/specification/claude-client.ts` returns 0 |
| 2 | Exports ClaudeClient | `grep -q "export class ClaudeClient" agents/specification/claude-client.ts` returns 0 |
| 3 | Has analyzeBrief method | `grep -q "analyzeBrief" agents/specification/claude-client.ts` returns 0 |
| 4 | Has generateTasks method | `grep -q "generateTasks" agents/specification/claude-client.ts` returns 0 |
| 5 | Has retry logic | `grep -q "retry" agents/specification/claude-client.ts` returns 0 |
| 6 | Uses Anthropic SDK | `grep -q "@anthropic-ai/sdk" agents/specification/claude-client.ts` returns 0 |
| 7 | TypeScript compiles | `npx tsc --noEmit agents/specification/claude-client.ts` returns 0 |
| 8 | Can make API call | Integration test with mock succeeds |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/specification/
├── claude-client.ts
└── prompts/
    ├── system.ts
    ├── analyze.ts
    └── tasks.ts
```

---

## Code Template

```typescript
// agents/specification/claude-client.ts

import Anthropic from '@anthropic-ai/sdk';

export class ClaudeClient {
  private client: Anthropic;

  async analyzeBrief(brief: ParsedBrief): Promise<AnalyzedRequirements> {
    // Call Claude with analysis prompt
  }

  async generateTasks(requirements: AnalyzedRequirements): Promise<AtomicTask[]> {
    // Call Claude with task generation prompt
  }

  private async call(prompt: string, retries = 3): Promise<string> {
    // API call with exponential backoff
  }
}
```

---

## Validation

```bash
npx tsc --noEmit agents/specification/claude-client.ts
npm test -- --grep "claude-client"
```
