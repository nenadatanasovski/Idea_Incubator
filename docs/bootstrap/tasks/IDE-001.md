# IDE-001: Session Persistence Improvements

---

## Metadata

| Field          | Value               |
| -------------- | ------------------- |
| **Phase**      | 3 - Ideation System |
| **Depends On** | FND-002             |
| **Blocks**     | IDE-002, IDE-003    |
| **Priority**   | P2                  |
| **Owner**      | Human + Claude Code |

---

## Summary

Improve the persistence layer for ideation sessions to ensure reliable storage and retrieval of session state, conversation history, and extracted signals across server restarts and client reconnections.

---

## Context

### Session Data Model

```typescript
interface IdeationSession {
  id: string;
  userId: string;
  ideaSlug: string | null;
  phase: "EXPLORING" | "NARROWING" | "VALIDATING" | "REFINING" | "COMPLETE";
  status: "active" | "paused" | "completed" | "archived";
  createdAt: string;
  updatedAt: string;
  messages: Message[];
  signals: ExtractedSignals;
  metadata: Record<string, unknown>;
}
```

### Current Issues

| Issue                    | Impact                              |
| ------------------------ | ----------------------------------- |
| Sessions lost on restart | User loses conversation history     |
| Large messages truncated | Context lost for long conversations |
| Signals not persisted    | Must re-extract on load             |

---

## Requirements

1. **Database Schema Updates**:
   - Add `messages` JSONB column (or separate table)
   - Add `signals` JSONB column
   - Add indexes for common queries

2. **Session Manager Improvements**:
   - Auto-save on every message
   - Batch writes for performance
   - Handle large conversations (pagination)

3. **Recovery Mechanisms**:
   - Detect and recover corrupted sessions
   - Auto-resume from last known state
   - Backup before destructive operations

4. **API Endpoints**:
   - GET `/api/ideation/sessions/:id` - Full session with messages
   - POST `/api/ideation/sessions/:id/messages` - Add message
   - GET `/api/ideation/sessions/:id/history` - Paginated history

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion                | How to Verify                        |
| --- | ------------------------ | ------------------------------------ |
| 1   | Sessions survive restart | Stop/start server, verify data       |
| 2   | Messages fully stored    | No truncation in long conversations  |
| 3   | Signals persisted        | Reload session, verify signals exist |
| 4   | API returns correct data | Test all endpoints                   |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/migrations/xxx_session_persistence.sql
server/routes/ideation/session-routes.ts    <- Updated
agents/ideation/session-manager.ts          <- Updated
tests/ideation/session-persistence.test.ts
```

---

## Validation

```bash
# Run persistence tests
npm test -- tests/ideation/session-persistence.test.ts

# Manual test: Create session, restart, verify
curl -X POST http://localhost:3001/api/ideation/sessions
# Save session ID
# Stop server: npm run stop
# Start server: npm run dev
curl http://localhost:3001/api/ideation/sessions/{id}
# Verify data intact
```

---

## Next Steps

After completing: Refine phase transition logic (IDE-002).
