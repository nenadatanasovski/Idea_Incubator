# TAK-020: TelegramHandler Service

---

## Metadata

| Field          | Value                        |
| -------------- | ---------------------------- |
| **Phase**      | 5 - Telegram Integration     |
| **Depends On** | TAK-016, TAK-019             |
| **Blocks**     | TAK-039 (Telegram E2E Tests) |
| **Priority**   | P1                           |
| **Owner**      | Build Agent                  |

---

## Summary

Implement the TelegramHandler class that handles all /task commands from Telegram, formats responses with inline buttons, and sends proactive notifications.

---

## Context

### Telegram Commands

| Command    | Description                       |
| ---------- | --------------------------------- |
| /start     | Link chat to task list            |
| /status    | Show current execution status     |
| /lists     | Show active task lists            |
| /suggest   | Get next suggested action         |
| /execute   | Start execution of suggested list |
| /pause     | Pause current execution           |
| /resume    | Resume paused execution           |
| /questions | Show pending questions            |
| /help      | Show available commands           |

---

## Requirements

1. **TelegramHandler class**:
   - Handle all /task commands from Telegram
   - Parse command arguments
   - Format responses with inline buttons
   - Support interactive task creation flow
   - Send proactive notifications

2. **Methods**:
   - `handleCommand(command, args, chatId): Promise<void>`
   - `sendSuggestion(chatId, task): Promise<void>`
   - `sendQuestion(chatId, question): Promise<void>`
   - `handleCallback(callbackData, chatId): Promise<void>`

3. **Inline Buttons**:
   - "Execute Now" / "Later" / "Details"
   - "Approve" / "Reject" / "More Info"
   - "Yes" / "No" / "Skip"

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion               | How to Verify                                                                                        |
| --- | ----------------------- | ---------------------------------------------------------------------------------------------------- |
| 1   | File exists             | `test -f server/services/task-agent/telegram-handler.ts` returns 0                                   |
| 2   | Exports TelegramHandler | `grep -q "export class TelegramHandler" server/services/task-agent/telegram-handler.ts` returns 0    |
| 3   | Has handleCommand       | `grep -q "handleCommand" server/services/task-agent/telegram-handler.ts` returns 0                   |
| 4   | Has inline buttons      | `grep -q "InlineKeyboard\|inline_keyboard" server/services/task-agent/telegram-handler.ts` returns 0 |
| 5   | TypeScript compiles     | `npx tsc --noEmit server/services/task-agent/telegram-handler.ts` returns 0                          |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/services/task-agent/
└── telegram-handler.ts
```

---

## Gotchas

- Use inline keyboards for actions (mobile-friendly)
- Keep messages concise for mobile
- Proactive suggestions: minimum 5-minute interval

---

## Validation

```bash
npx tsc --noEmit server/services/task-agent/telegram-handler.ts
npm test -- --grep "telegram-handler"
```

---

## Next Steps

After completing: Add task-agent WebSocket events (TAK-021).
