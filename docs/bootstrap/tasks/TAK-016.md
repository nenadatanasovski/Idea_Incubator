# TAK-016: TaskAgent Main Service

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 3 - Core Services |
| **Depends On** | TAK-008, TAK-009, TAK-010, TAK-011, TAK-012, TAK-013, TAK-014, TAK-015, TAK-015a, TAK-015b, TAK-015c |
| **Blocks** | TAK-017 (API Routes), TAK-019 (TelegramHandler), TAK-021 (WebSocket) |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Implement the main TaskAgent class that coordinates all sub-services, implements the always-on loop with continuous suggestions, and handles Telegram commands.

---

## Context

### Architecture Overview

```
TaskAgent (Main Coordinator)
├── ValidationGate (TAK-008)
├── DeduplicationEngine (TAK-009)
├── ClassificationEngine (TAK-010)
├── TestGenerator (TAK-011)
├── LifecycleManager (TAK-012)
├── DependencyManager (TAK-013)
├── CompletionDetector (TAK-014)
├── TestExecutor (TAK-015)
├── PriorityCalculator (TAK-015a)
├── SuggestionEngine (TAK-015b)
└── TaskListManager (TAK-015c)
```

---

## Requirements

1. **TaskAgent class**:
   - Coordinate all sub-services
   - Register with CommunicationHub
   - Subscribe to relevant events
   - Implement always-on loop with continuous suggestions
   - Handle incoming Telegram commands
   - Proactively check for stale tasks (every 6 hours)

2. **Methods**:
   - `start(): Promise<void>` - Initialize and start loop
   - `stop(): Promise<void>` - Graceful shutdown
   - `handleEvent(event): Promise<void>` - Process events
   - `handleTelegramCommand(command): Promise<void>`
   - `checkStale(): Promise<void>` - Find stale tasks
   - `runSuggestionLoop(): Promise<void>`

3. **Event Subscriptions**:
   - `ideation.completed` - Generate spec + tasks
   - `task.completed` - Auto-unblock dependents
   - `task.failed` - Handle failure flows
   - `build.completed` - Update task status

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | File exists | `test -f server/services/task-agent/task-agent.ts` returns 0 |
| 2 | Exports TaskAgent | `grep -q "export class TaskAgent" server/services/task-agent/task-agent.ts` returns 0 |
| 3 | Has start method | `grep -q "async start" server/services/task-agent/task-agent.ts` returns 0 |
| 4 | Has stop method | `grep -q "async stop" server/services/task-agent/task-agent.ts` returns 0 |
| 5 | Has event handling | `grep -q "handleEvent\|subscribe" server/services/task-agent/task-agent.ts` returns 0 |
| 6 | Has stale check | `grep -q "checkStale\|stale" server/services/task-agent/task-agent.ts` returns 0 |
| 7 | TypeScript compiles | `npx tsc --noEmit server/services/task-agent/task-agent.ts` returns 0 |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/services/task-agent/
├── task-agent.ts
└── index.ts (re-exports)
```

---

## Gotchas

- Must register with CommunicationHub on startup
- Use long-polling for Telegram
- Implement graceful shutdown to complete in-progress tasks
- Run stale check every 6 hours (configurable)

---

## Validation

```bash
npx tsc --noEmit server/services/task-agent/task-agent.ts
npm test -- --grep "task-agent"
```

---

## Next Steps

After completing: Create REST API routes (TAK-017).
