# UFS-002: Migrate Artifacts to File-Based Storage

---

## Metadata

| Field          | Value                   |
| -------------- | ----------------------- |
| **Phase**      | 2 - Unified File System |
| **Depends On** | UFS-001                 |
| **Blocks**     | UFS-003                 |
| **Priority**   | P1                      |
| **Owner**      | Human + Claude Code     |

---

## Summary

Migrate existing artifacts from the database (ideation_artifacts table) to the unified file system structure. Each artifact type maps to a specific file in the folder hierarchy.

---

## Context

### Artifact Type Mapping

| Artifact Type           | Target File               |
| ----------------------- | ------------------------- |
| `readme`                | `README.md`               |
| `development`           | `development.md`          |
| `target-user`           | `target-users.md`         |
| `problem-solution`      | `problem-solution.md`     |
| `market-research`       | `research/market.md`      |
| `competitive-analysis`  | `research/competitive.md` |
| `technical-feasibility` | `research/technical.md`   |
| `brief`                 | `planning/brief.md`       |
| `mvp-scope`             | `planning/mvp-scope.md`   |
| `spec`                  | `build/spec.md`           |
| `tasks`                 | `build/tasks.md`          |
| `redteam`               | `analysis/redteam.md`     |

### Migration Strategy

1. Read all artifacts from database
2. Group by idea
3. Create folder structure for each idea
4. Write artifact content to appropriate files
5. Verify migration success
6. (Later) Remove from database

---

## Requirements

1. **Export Artifacts**:
   - Query all artifacts from `ideation_artifacts` table
   - Include metadata (session_id, created_at, updated_at)
   - Handle missing or null content gracefully

2. **Create Migration Script**:
   - Idempotent (can run multiple times safely)
   - Creates folders if they don't exist
   - Preserves existing file content (merge or skip)
   - Logs progress and errors

3. **Content Transformation**:
   - Add YAML frontmatter with metadata
   - Preserve original markdown formatting
   - Handle special characters

4. **Verification**:
   - Compare artifact count: database vs files
   - Verify content integrity
   - Report any discrepancies

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion                | How to Verify                     |
| --- | ------------------------ | --------------------------------- |
| 1   | All artifacts exported   | File count matches database count |
| 2   | Content preserved        | Spot-check 5 random files         |
| 3   | Folder structure correct | All files in correct locations    |
| 4   | Migration is idempotent  | Run twice, same result            |

**FAIL** if any criterion is not met.

---

## Output Files

```
scripts/migrate-artifacts.ts     <- Migration script
logs/migration-{date}.json       <- Migration log
users/{user}/ideas/{idea}/*      <- Migrated files
```

---

## Code Template

```typescript
// scripts/migrate-artifacts.ts

interface MigrationResult {
  total: number;
  migrated: number;
  skipped: number;
  errors: Array<{ artifactId: string; error: string }>;
}

async function migrateArtifacts(): Promise<MigrationResult> {
  const artifacts = await query<Artifact>(
    "SELECT * FROM ideation_artifacts ORDER BY idea_slug, created_at",
  );

  const result: MigrationResult = {
    total: artifacts.length,
    migrated: 0,
    skipped: 0,
    errors: [],
  };

  // Group by idea
  const byIdea = groupBy(artifacts, (a) => `${a.user_slug}/${a.idea_slug}`);

  for (const [ideaKey, ideaArtifacts] of Object.entries(byIdea)) {
    const [userSlug, ideaSlug] = ideaKey.split("/");

    // Ensure folder exists
    await createIdeaFolder(userSlug, ideaSlug);

    for (const artifact of ideaArtifacts) {
      try {
        const filePath = getFilePath(userSlug, ideaSlug, artifact.type);
        const content = formatWithFrontmatter(artifact);
        await writeFile(filePath, content);
        result.migrated++;
      } catch (error) {
        result.errors.push({ artifactId: artifact.id, error: error.message });
      }
    }
  }

  return result;
}
```

---

## Validation

```bash
# Run migration
npx ts-node scripts/migrate-artifacts.ts

# Verify file count
find users -name "*.md" | wc -l

# Compare with database
sqlite3 database/ideas.db "SELECT COUNT(*) FROM ideation_artifacts"

# Spot check content
cat users/test-user/ideas/test-idea/README.md
```

---

## Next Steps

After completing: Update artifact store to read/write files instead of database (UFS-003).
