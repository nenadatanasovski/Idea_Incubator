# QUE-002: Queue Priority Management

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 4 - Question System |
| **Depends On** | QUE-001 |
| **Blocks** | QUE-003 |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Implement priority calculation and queue ordering for questions.

---

## Requirements

1. **Priority Calculation**:
   - Base priority by question type (BLOCKING=100, CLARIFYING=50, etc.)
   - Boost for age (older questions get priority)
   - Boost for blocking downstream tasks
   - Penalty for low-confidence questions

2. **Queue Operations**:
   - Get next question (highest priority pending)
   - Get all pending questions sorted
   - Reorder on new question arrival
   - Expire old questions

3. **Query Layer**:
   - TypeScript queries for question operations
   - Efficient priority retrieval
   - Batch operations for "answer all defaults"

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | File exists | `test -f database/queries/questions.ts` returns 0 |
| 2 | Has calculatePriority | `grep -q "calculatePriority" database/queries/questions.ts` returns 0 |
| 3 | Has getNextQuestion | `grep -q "getNextQuestion" database/queries/questions.ts` returns 0 |
| 4 | Has getPendingQuestions | `grep -q "getPendingQuestions" database/queries/questions.ts` returns 0 |
| 5 | Has expireOldQuestions | `grep -q "expireOld" database/queries/questions.ts` returns 0 |
| 6 | TypeScript compiles | `npx tsc --noEmit database/queries/questions.ts` returns 0 |
| 7 | Unit tests pass | `npm test -- --grep "question-queries"` passes |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/queries/
└── questions.ts
```

---

## Code Template

```typescript
// database/queries/questions.ts

export interface QuestionPriority {
  questionId: string;
  basePriority: number;
  ageBoost: number;
  blockingBoost: number;
  totalPriority: number;
}

export function calculatePriority(question: Question): number {
  const basePriorities = {
    BLOCKING: 100,
    CLARIFYING: 50,
    CONFIRMING: 30,
    PREFERENCE: 20,
  };
  // Add age boost, blocking boost
}

export async function getNextQuestion(db: Database): Promise<Question | null> {
  // Get highest priority pending question
}

export async function getPendingQuestions(db: Database): Promise<Question[]> {
  // Get all pending sorted by priority
}

export async function answerAllDefaults(db: Database): Promise<number> {
  // Answer all non-blocking with defaults
}
```

---

## Validation

```bash
npx tsc --noEmit database/queries/questions.ts
npm test -- --grep "question-queries"
```
