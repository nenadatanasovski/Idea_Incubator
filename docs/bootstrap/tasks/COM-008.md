# COM-008: Gmail SMTP Email Sender

---

## Metadata

| Field          | Value                  |
| -------------- | ---------------------- |
| **Phase**      | 0 - Communication Core |
| **Depends On** | FND-002                |
| **Blocks**     | COM-009                |
| **Priority**   | P1                     |
| **Owner**      | Build Agent            |

---

## Summary

Implement the email sender using Gmail SMTP for fallback communication when Telegram is unavailable.

---

## Context

### Gmail SMTP Configuration

Gmail SMTP requires:

- Email: Your Gmail address
- Password: App-specific password (NOT your regular password)
- Host: smtp.gmail.com
- Port: 587 (TLS) or 465 (SSL)

### Creating App Password

1. Go to Google Account ‚Üí Security
2. Enable 2-Step Verification (required)
3. Go to App passwords
4. Create password for "Mail" on "Other (Custom name)"
5. Use this 16-character password in .env

---

## Requirements

1. **SMTP Connection**:
   - Use nodemailer or similar
   - TLS encryption
   - Connection pooling for efficiency

2. **Email Sending**:
   - Send plain text and HTML emails
   - Support attachments (for logs, screenshots)
   - Track delivery status

3. **Rate Limiting**:
   - Gmail limits: 500 emails/day
   - Queue emails if rate limited
   - Log warning when approaching limit

4. **Error Handling**:
   - Retry on transient failures
   - Report permanent failures
   - Queue for later if connection down

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion               | How to Verify                                                                       |
| --- | ----------------------- | ----------------------------------------------------------------------------------- |
| 1   | File exists             | `test -f server/communication/email-sender.ts` returns 0                            |
| 2   | Exports EmailSender     | `grep -q "export class EmailSender" server/communication/email-sender.ts` returns 0 |
| 3   | Has send method         | `grep -q "send(" server/communication/email-sender.ts` returns 0                    |
| 4   | Uses nodemailer or SMTP | `grep -q "nodemailer\|smtp\|SMTP" server/communication/email-sender.ts` returns 0   |
| 5   | Has retry logic         | `grep -q "retry\|Retry" server/communication/email-sender.ts` returns 0             |
| 6   | TypeScript compiles     | `npx tsc --noEmit server/communication/email-sender.ts` returns 0                   |
| 7   | Unit tests pass         | `npm test -- --grep "email-sender"` passes                                          |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/communication/
‚îî‚îÄ‚îÄ email-sender.ts
```

---

## Environment Variables

```bash
# .env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=xxxx-xxxx-xxxx-xxxx  # App-specific password
SMTP_FROM=Vibe Platform <your-email@gmail.com>
```

---

## Code Template

```typescript
// server/communication/email-sender.ts

import nodemailer from "nodemailer";

interface EmailConfig {
  host: string;
  port: number;
  user: string;
  pass: string;
  from: string;
}

interface EmailMessage {
  to: string;
  subject: string;
  text: string;
  html?: string;
  attachments?: {
    filename: string;
    content: string | Buffer;
  }[];
}

interface SendResult {
  success: boolean;
  messageId?: string;
  error?: string;
}

export class EmailSender {
  private config: EmailConfig;
  private transporter: nodemailer.Transporter;
  private dailySendCount: number = 0;
  private lastResetDate: string = "";

  constructor(config?: Partial<EmailConfig>) {
    this.config = {
      host: config?.host || process.env.SMTP_HOST || "smtp.gmail.com",
      port: config?.port || parseInt(process.env.SMTP_PORT || "587"),
      user: config?.user || process.env.SMTP_USER || "",
      pass: config?.pass || process.env.SMTP_PASS || "",
      from: config?.from || process.env.SMTP_FROM || "",
    };

    this.transporter = nodemailer.createTransport({
      host: this.config.host,
      port: this.config.port,
      secure: this.config.port === 465,
      auth: {
        user: this.config.user,
        pass: this.config.pass,
      },
    });
  }

  async send(message: EmailMessage): Promise<SendResult> {
    // Check daily limit
    this.resetDailyCountIfNeeded();

    if (this.dailySendCount >= 450) {
      console.warn("Approaching Gmail daily limit (500). Email queued.");
      // In production, queue for later
      return { success: false, error: "Rate limit approaching" };
    }

    return this.sendWithRetry(message);
  }

  async sendQuestion(
    to: string,
    questionId: string,
    questionContent: string,
    options: { label: string; action: string }[],
  ): Promise<SendResult> {
    const optionsList = options
      .map((opt, i) => `${i + 1}. ${opt.label}`)
      .join("\n");

    const text = `
VIBE PLATFORM - Question Requires Your Answer

${questionContent}

Options:
${optionsList}

To answer, reply to this email with just the number (1, 2, etc.) or type your own response.

Question ID: ${questionId}
---
This is an automated message from Vibe Platform.
    `.trim();

    const html = `
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
  <h2 style="color: #333;">ü§ñ Vibe Platform</h2>
  <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
    <p style="white-space: pre-wrap;">${questionContent}</p>
  </div>
  <h3>Options:</h3>
  <ol>
    ${options.map((opt) => `<li><strong>${opt.label}</strong></li>`).join("")}
  </ol>
  <p style="color: #666; font-size: 12px;">
    Reply with the number (1, 2, etc.) or type your own response.<br>
    Question ID: ${questionId}
  </p>
</div>
    `.trim();

    return this.send({
      to,
      subject: `[Vibe] Question: ${questionContent.substring(0, 50)}...`,
      text,
      html,
    });
  }

  async sendAlert(
    to: string,
    alert: {
      title: string;
      message: string;
      severity: "info" | "warning" | "error" | "critical";
    },
  ): Promise<SendResult> {
    const severityEmoji = {
      info: "‚ÑπÔ∏è",
      warning: "‚ö†Ô∏è",
      error: "‚ùå",
      critical: "üö®",
    };

    return this.send({
      to,
      subject: `[Vibe ${alert.severity.toUpperCase()}] ${alert.title}`,
      text: `${severityEmoji[alert.severity]} ${alert.title}\n\n${alert.message}`,
    });
  }

  async verify(): Promise<boolean> {
    try {
      await this.transporter.verify();
      return true;
    } catch (error) {
      console.error("SMTP verification failed:", error);
      return false;
    }
  }

  private async sendWithRetry(
    message: EmailMessage,
    attempt: number = 1,
  ): Promise<SendResult> {
    const maxAttempts = 3;

    try {
      const info = await this.transporter.sendMail({
        from: this.config.from,
        to: message.to,
        subject: message.subject,
        text: message.text,
        html: message.html,
        attachments: message.attachments,
      });

      this.dailySendCount++;

      return {
        success: true,
        messageId: info.messageId,
      };
    } catch (error) {
      const err = error as Error;

      // Retry on transient errors
      if (attempt < maxAttempts && this.isRetryableError(err)) {
        await this.delay(1000 * Math.pow(2, attempt - 1));
        return this.sendWithRetry(message, attempt + 1);
      }

      return {
        success: false,
        error: err.message,
      };
    }
  }

  private isRetryableError(error: Error): boolean {
    const retryableMessages = [
      "ETIMEDOUT",
      "ECONNRESET",
      "ECONNREFUSED",
      "temporary",
      "try again",
    ];

    return retryableMessages.some((msg) =>
      error.message.toLowerCase().includes(msg.toLowerCase()),
    );
  }

  private resetDailyCountIfNeeded(): void {
    const today = new Date().toISOString().split("T")[0];
    if (this.lastResetDate !== today) {
      this.dailySendCount = 0;
      this.lastResetDate = today;
    }
  }

  private delay(ms: number): Promise<void> {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }
}
```

---

## Validation

```bash
# Install nodemailer if not present
npm install nodemailer
npm install --save-dev @types/nodemailer

# Compile
npx tsc --noEmit server/communication/email-sender.ts

# Test connection
npm test -- --grep "email-sender"
```

---

## Test Script

```typescript
// scripts/test-email.ts

import { EmailSender } from "../server/communication/email-sender";

async function testEmail() {
  const sender = new EmailSender();

  // Verify connection
  const verified = await sender.verify();
  console.log("SMTP connection:", verified ? "OK" : "FAILED");

  if (!verified) return;

  // Send test email
  const result = await sender.send({
    to: process.env.PRIMARY_EMAIL,
    subject: "Vibe Platform Test",
    text: "This is a test email from Vibe Platform.",
  });

  console.log("Send result:", result);
}

testEmail();
```
