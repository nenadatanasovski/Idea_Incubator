# TAK-006: Validation Rules Migration

---

## Metadata

| Field          | Value                    |
| -------------- | ------------------------ |
| **Phase**      | 1 - Database Schema      |
| **Depends On** | None                     |
| **Blocks**     | TAK-008 (ValidationGate) |
| **Priority**   | P1                       |
| **Owner**      | Build Agent              |

---

## Summary

Create the validation_rules table for configurable validation. Allows defining rules for required fields, test requirements, pattern matching, and custom validation.

---

## Requirements

1. **Create validation_rules table**:
   - name (unique identifier)
   - rule_type: required_field, test_required, pattern_match, custom, ambiguity_check
   - category_filter (NULL = all categories, or specific category)
   - config as JSON
   - severity: error, warning, info
   - blocking flag (1 = blocks execution)
   - enabled flag

2. **Seed default validation rules**:
   - title_required (min 10 chars)
   - description_required (min 50 chars)
   - category_required
   - acceptance_criteria_required (min 1 item)
   - api_tests_for_backend (feature/improvement/bug categories)
   - ui_tests_for_frontend (feature/improvement/ux_design categories)
   - ambiguity_check (vague terms detection)

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion             | How to Verify                                                                                                   |
| --- | --------------------- | --------------------------------------------------------------------------------------------------------------- |
| 1   | Migration file exists | `test -f database/migrations/055_validation_rules.sql` returns 0                                                |
| 2   | Has table             | `grep -q "CREATE TABLE IF NOT EXISTS validation_rules" database/migrations/055_validation_rules.sql` returns 0  |
| 3   | Has rule types        | `grep -q "required_field.*test_required.*pattern_match" database/migrations/055_validation_rules.sql` returns 0 |
| 4   | Has default rules     | `grep -q "INSERT.*title_required" database/migrations/055_validation_rules.sql` returns 0                       |
| 5   | Migration runs        | `sqlite3 :memory: < database/migrations/055_validation_rules.sql && echo 'OK'` returns "OK"                     |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/migrations/
└── 055_validation_rules.sql
```

---

## Code Template

```sql
-- Migration 055: Validation rules

CREATE TABLE IF NOT EXISTS validation_rules (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  description TEXT,
  rule_type TEXT NOT NULL CHECK (rule_type IN
    ('required_field', 'test_required', 'pattern_match', 'custom', 'ambiguity_check')),
  category_filter TEXT,  -- NULL = all categories, or specific category
  config TEXT NOT NULL,  -- JSON configuration
  severity TEXT NOT NULL DEFAULT 'error' CHECK (severity IN ('error', 'warning', 'info')),
  blocking INTEGER NOT NULL DEFAULT 1,  -- 1 = blocks execution
  enabled INTEGER NOT NULL DEFAULT 1,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Default validation rules
INSERT OR IGNORE INTO validation_rules (id, name, rule_type, config, severity, blocking) VALUES
  ('vr-001', 'title_required', 'required_field', '{"field":"title","minLength":10}', 'error', 1),
  ('vr-002', 'description_required', 'required_field', '{"field":"description","minLength":50}', 'error', 1),
  ('vr-003', 'category_required', 'required_field', '{"field":"category"}', 'error', 1),
  ('vr-004', 'acceptance_criteria_required', 'required_field', '{"field":"acceptance_criteria","minItems":1}', 'error', 1),
  ('vr-005', 'api_tests_for_backend', 'test_required', '{"testType":"api","categories":["feature","improvement","bug"],"condition":"affects_backend"}', 'error', 1),
  ('vr-006', 'ui_tests_for_frontend', 'test_required', '{"testType":"ui","categories":["feature","improvement","ux_design"],"condition":"affects_frontend"}', 'error', 1),
  ('vr-007', 'ambiguity_check', 'ambiguity_check', '{"threshold":0.3,"vagueTerms":["improve","enhance","better","fix","update","some","various"]}', 'warning', 0);
```

---

## Validation

```bash
npm run migrate
sqlite3 database/ideas.db "SELECT name, rule_type FROM validation_rules"
```

---

## Next Steps

After completing: Create task_lists table (TAK-006a).
