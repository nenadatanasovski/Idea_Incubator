# MON-003: Puppeteer MCP Observer (UI Validation)

---

## Metadata

| Field          | Value                     |
| -------------- | ------------------------- |
| **Phase**      | 2 - Monitoring Agent      |
| **Depends On** | MON-001, WEB-001, WEB-002 |
| **Blocks**     | MON-004                   |
| **Priority**   | P1                        |
| **Owner**      | Human (then Build Agent)  |

---

## Summary

Implement the Puppeteer MCP Observer that validates the dashboard UI state. This is the secondary data source that validates user experience and catches UI bugs.

---

## Requirements

1. **MCP Integration**:
   - Use mcp**puppeteer**\* tools for browser control
   - Navigate between dashboard tabs
   - Capture DOM state
   - Optional: Screenshot for vision analysis

2. **State Capture**:
   - Parse agent status cards
   - Parse question queue
   - Capture timeline events
   - Detect visual anomalies

3. **Observation Cadence**:
   - 5-10 second intervals (configurable)
   - Faster during active issues
   - Slower when system idle

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion                 | How to Verify                                                                                |
| --- | ------------------------- | -------------------------------------------------------------------------------------------- |
| 1   | File exists               | `test -f agents/monitoring/puppeteer-observer.ts` returns 0                                  |
| 2   | Exports PuppeteerObserver | `grep -q "export class PuppeteerObserver" agents/monitoring/puppeteer-observer.ts` returns 0 |
| 3   | Has initialize method     | `grep -q "initialize(" agents/monitoring/puppeteer-observer.ts` returns 0                    |
| 4   | Has captureState method   | `grep -q "captureState(" agents/monitoring/puppeteer-observer.ts` returns 0                  |
| 5   | Parses agent cards        | `grep -q "parseAgentCards\|AgentCard" agents/monitoring/puppeteer-observer.ts` returns 0     |
| 6   | Configurable interval     | `grep -q "interval\|Interval" agents/monitoring/puppeteer-observer.ts` returns 0             |
| 7   | TypeScript compiles       | `npx tsc --noEmit agents/monitoring/puppeteer-observer.ts` returns 0                         |
| 8   | Integration test passes   | Manual: observer captures dashboard state correctly                                          |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/monitoring/
└── puppeteer-observer.ts
```

---

## Code Template

```typescript
// agents/monitoring/puppeteer-observer.ts

export interface UIAgentState {
  agentId: string;
  displayedStatus: string;
  displayedTask?: string;
  progressBar?: number;
  hasError: boolean;
  capturedAt: Date;
}

export interface UIQuestionState {
  questionId: string;
  questionType: string;
  agentSource: string;
  isBlocking: boolean;
  ageText: string;
}

export interface UIState {
  agents: UIAgentState[];
  questions: UIQuestionState[];
  timelineEvents: string[];
  capturedAt: Date;
  tabUrl: string;
}

export class PuppeteerObserver {
  private config: PuppeteerConfig;
  private connected: boolean = false;
  private lastCapture?: UIState;

  constructor(config: PuppeteerConfig) {
    this.config = config;
  }

  async initialize(): Promise<void> {
    // Navigate to dashboard
    await this.navigateToDashboard();
    this.connected = true;
  }

  async close(): Promise<void> {
    this.connected = false;
  }

  isConnected(): boolean {
    return this.connected;
  }

  async captureState(): Promise<UIState> {
    // 1. Ensure we're on dashboard
    await this.ensureOnDashboard();

    // 2. Capture agent cards
    const agents = await this.parseAgentCards();

    // 3. Capture question queue
    const questions = await this.parseQuestionQueue();

    // 4. Capture timeline
    const timelineEvents = await this.parseTimeline();

    const state: UIState = {
      agents,
      questions,
      timelineEvents,
      capturedAt: new Date(),
      tabUrl: await this.getCurrentUrl(),
    };

    this.lastCapture = state;
    return state;
  }

  private async navigateToDashboard(): Promise<void> {
    // Use mcp__puppeteer__puppeteer_navigate
  }

  private async parseAgentCards(): Promise<UIAgentState[]> {
    // Use mcp__puppeteer__puppeteer_evaluate to extract DOM
    // Parse agent status cards
    const result = await this.evaluate(`
      Array.from(document.querySelectorAll('[data-agent-card]')).map(card => ({
        agentId: card.dataset.agentId,
        displayedStatus: card.querySelector('.status')?.textContent,
        displayedTask: card.querySelector('.current-task')?.textContent,
        progressBar: parseFloat(card.querySelector('.progress')?.style.width || '0'),
        hasError: card.classList.contains('error'),
      }))
    `);
    return result;
  }

  private async parseQuestionQueue(): Promise<UIQuestionState[]> {
    // Similar DOM extraction for question queue
  }

  private async parseTimeline(): Promise<string[]> {
    // Extract timeline event text
  }

  private async evaluate(script: string): Promise<any> {
    // Use mcp__puppeteer__puppeteer_evaluate
  }
}
```

---

## Validation

```bash
npx tsc --noEmit agents/monitoring/puppeteer-observer.ts
# Manual: start dashboard, run observer, verify state captured correctly
```
