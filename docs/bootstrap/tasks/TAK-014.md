# TAK-014: CompletionDetector Service

---

## Metadata

| Field          | Value               |
| -------------- | ------------------- |
| **Phase**      | 3 - Core Services   |
| **Depends On** | TAK-007             |
| **Blocks**     | TAK-016 (TaskAgent) |
| **Priority**   | P1                  |
| **Owner**      | Build Agent         |

---

## Summary

Implement the CompletionDetector class that proactively monitors for task completion signals: git commits, passing tests, and file changes.

---

## Requirements

1. **CompletionDetector class**:
   - Monitor git commits for task ID mentions
   - Watch test results for task tests passing
   - Track file changes matching predicted files
   - Calculate completion confidence
   - Suggest marking task complete (don't auto-complete)

2. **Methods**:
   - `checkCompletion(taskId): Promise<CompletionSignals>`
   - `scanGitCommits(taskId): Promise<Commit[]>`
   - `checkTestResults(taskId): Promise<TestStatus>`
   - `checkFileChanges(taskId): Promise<FileChange[]>`
   - `calculateConfidence(signals): number`

3. **Confidence Calculation**:
   - Git commit mentions task: +30%
   - Tests passing: +40%
   - Predicted files changed: +20%
   - Acceptance criteria met: +10%

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion                  | How to Verify                                                                                           |
| --- | -------------------------- | ------------------------------------------------------------------------------------------------------- |
| 1   | File exists                | `test -f server/services/task-agent/completion-detector.ts` returns 0                                   |
| 2   | Exports CompletionDetector | `grep -q "export class CompletionDetector" server/services/task-agent/completion-detector.ts` returns 0 |
| 3   | Has checkCompletion        | `grep -q "checkCompletion" server/services/task-agent/completion-detector.ts` returns 0                 |
| 4   | Has calculateConfidence    | `grep -q "calculateConfidence" server/services/task-agent/completion-detector.ts` returns 0             |
| 5   | TypeScript compiles        | `npx tsc --noEmit server/services/task-agent/completion-detector.ts` returns 0                          |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/services/task-agent/
└── completion-detector.ts
```

---

## Gotchas

- Don't auto-complete, only suggest
- Multiple signals increase confidence
- Parse git commit messages for task IDs (e.g., "TAK-001", "fixes #123")

---

## Validation

```bash
npx tsc --noEmit server/services/task-agent/completion-detector.ts
npm test -- --grep "completion-detector"
```

---

## Next Steps

After completing: Implement TestExecutor (TAK-015).
