# MON-008: Heartbeat Emitter

---

## Metadata

| Field          | Value                    |
| -------------- | ------------------------ |
| **Phase**      | 2 - Monitoring Agent     |
| **Depends On** | MON-001                  |
| **Blocks**     | None                     |
| **Priority**   | P1                       |
| **Owner**      | Human (then Build Agent) |

---

## Summary

Implement the Heartbeat Emitter that signals Monitoring Agent health to all other systems. This is the system-wide health dependency - if heartbeat stops, all loops pause.

---

## Requirements

1. **Heartbeat Emission**:
   - Emit every 10 seconds
   - Include connection statuses
   - Include agents monitored count
   - Include last observation timestamp

2. **Health States**:
   - HEALTHY: Both sources connected
   - DEGRADED: One source down
   - UNHEALTHY: Both down or no observations
   - CRITICAL: Unhealthy > 5 minutes

3. **Consumer Integration**:
   - Other systems subscribe to heartbeat
   - 3 missed heartbeats (30s) → assume unhealthy
   - Consumers pause their loops

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion                | How to Verify                                                                              |
| --- | ------------------------ | ------------------------------------------------------------------------------------------ |
| 1   | File exists              | `test -f agents/monitoring/heartbeat-emitter.ts` returns 0                                 |
| 2   | Exports HeartbeatEmitter | `grep -q "export class HeartbeatEmitter" agents/monitoring/heartbeat-emitter.ts` returns 0 |
| 3   | Has start/stop methods   | `grep -q "start\|stop" agents/monitoring/heartbeat-emitter.ts` returns 0                   |
| 4   | Emits every 10s          | `grep -q "10.*000\|10_000" agents/monitoring/heartbeat-emitter.ts` returns 0               |
| 5   | Includes health state    | `grep -q "HEALTHY\|DEGRADED\|UNHEALTHY" agents/monitoring/heartbeat-emitter.ts` returns 0  |
| 6   | TypeScript compiles      | `npx tsc --noEmit agents/monitoring/heartbeat-emitter.ts` returns 0                        |
| 7   | Unit tests pass          | `npm test -- --grep "heartbeat-emitter"` passes                                            |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/monitoring/
└── heartbeat-emitter.ts
```

---

## Code Template

```typescript
// agents/monitoring/heartbeat-emitter.ts

import { EventBus } from "../../server/orchestration/event-bus";

export type HealthState = "HEALTHY" | "DEGRADED" | "UNHEALTHY" | "CRITICAL";

export interface HeartbeatPayload {
  timestamp: Date;
  healthState: HealthState;
  eventBusConnected: boolean;
  puppeteerConnected: boolean;
  agentsMonitored: number;
  lastObservation: Date | null;
  uptimeMs: number;
  issuesDetected: number;
  actionsExecuted: number;
}

export class HeartbeatEmitter {
  private eventBus: EventBus;
  private interval: ReturnType<typeof setInterval> | null = null;
  private startTime: Date = new Date();
  private config: HeartbeatConfig;

  // State providers (injected from MonitoringAgent)
  private getEventBusConnected: () => boolean;
  private getPuppeteerConnected: () => boolean;
  private getAgentsMonitoredCount: () => number;
  private getLastObservation: () => Date | null;
  private getIssuesDetectedCount: () => number;
  private getActionsExecutedCount: () => number;

  private unhealthyStartTime: Date | null = null;

  constructor(
    eventBus: EventBus,
    config: HeartbeatConfig,
    stateProviders: StateProviders,
  ) {
    this.eventBus = eventBus;
    this.config = config;
    this.getEventBusConnected = stateProviders.getEventBusConnected;
    this.getPuppeteerConnected = stateProviders.getPuppeteerConnected;
    this.getAgentsMonitoredCount = stateProviders.getAgentsMonitoredCount;
    this.getLastObservation = stateProviders.getLastObservation;
    this.getIssuesDetectedCount = stateProviders.getIssuesDetectedCount;
    this.getActionsExecutedCount = stateProviders.getActionsExecutedCount;
  }

  start(): void {
    this.startTime = new Date();
    this.interval = setInterval(() => {
      this.emit();
    }, this.config.intervalMs); // 10_000 default

    // Emit immediately on start
    this.emit();
  }

  stop(): void {
    if (this.interval) {
      clearInterval(this.interval);
      this.interval = null;
    }
  }

  private emit(): void {
    const healthState = this.calculateHealthState();

    const payload: HeartbeatPayload = {
      timestamp: new Date(),
      healthState,
      eventBusConnected: this.getEventBusConnected(),
      puppeteerConnected: this.getPuppeteerConnected(),
      agentsMonitored: this.getAgentsMonitoredCount(),
      lastObservation: this.getLastObservation(),
      uptimeMs: Date.now() - this.startTime.getTime(),
      issuesDetected: this.getIssuesDetectedCount(),
      actionsExecuted: this.getActionsExecutedCount(),
    };

    this.eventBus.publish("monitoring_heartbeat", payload);
  }

  private calculateHealthState(): HealthState {
    const ebConnected = this.getEventBusConnected();
    const puppeteerConnected = this.getPuppeteerConnected();

    if (ebConnected && puppeteerConnected) {
      this.unhealthyStartTime = null;
      return "HEALTHY";
    }

    if (ebConnected || puppeteerConnected) {
      this.unhealthyStartTime = null;
      return "DEGRADED";
    }

    // Both down
    if (!this.unhealthyStartTime) {
      this.unhealthyStartTime = new Date();
    }

    const unhealthyDuration = Date.now() - this.unhealthyStartTime.getTime();
    if (unhealthyDuration > this.config.criticalThresholdMs) {
      return "CRITICAL";
    }

    return "UNHEALTHY";
  }
}

interface HeartbeatConfig {
  intervalMs: number; // 10_000 default
  criticalThresholdMs: number; // 300_000 (5 min) default
}

interface StateProviders {
  getEventBusConnected: () => boolean;
  getPuppeteerConnected: () => boolean;
  getAgentsMonitoredCount: () => number;
  getLastObservation: () => Date | null;
  getIssuesDetectedCount: () => number;
  getActionsExecutedCount: () => number;
}
```

---

## Consumer Example

```typescript
// In any system that depends on Monitoring Agent health

class SessionManager {
  private lastHeartbeat: Date = new Date();
  private healthState: HealthState = "UNKNOWN";

  constructor(eventBus: EventBus) {
    eventBus.subscribe("monitoring_heartbeat", (event) => {
      this.lastHeartbeat = new Date();
      this.healthState = event.payload.healthState;
    });

    // Check for stale heartbeat
    setInterval(() => {
      const staleness = Date.now() - this.lastHeartbeat.getTime();
      if (staleness > 30_000) {
        // 3 missed heartbeats
        this.healthState = "UNHEALTHY";
        this.pauseAllSessions("Monitoring Agent unresponsive");
      }
    }, 10_000);
  }

  canProceed(): boolean {
    return this.healthState === "HEALTHY" || this.healthState === "DEGRADED";
  }
}
```

---

## Validation

```bash
npx tsc --noEmit agents/monitoring/heartbeat-emitter.ts
npm test -- --grep "heartbeat-emitter"
```
