# QUE-001: Question Queue Database Schema

---

## Metadata

| Field          | Value               |
| -------------- | ------------------- |
| **Phase**      | 4 - Question System |
| **Depends On** | FND-002             |
| **Blocks**     | QUE-002, QUE-003    |
| **Priority**   | P1                  |
| **Owner**      | Build Agent         |

---

## Summary

Create database schema for storing and managing agent questions and user answers.

---

## Requirements

1. **Questions Table**:
   - id (UUID)
   - agent_id (FK)
   - session_id (FK)
   - type (BLOCKING/CLARIFYING/CONFIRMING/PREFERENCE/ALERT/ESCALATION/APPROVAL/DECISION)
   - content (text)
   - context (JSON)
   - options (JSON, nullable)
   - default_answer (nullable)
   - priority (integer)
   - blocking (boolean) - whether agent is paused waiting for answer
   - status (pending/answered/expired/skipped)
   - timeout_ms (integer, nullable) - auto-answer after this duration
   - timeout_action (text, nullable) - action to take on timeout
   - created_at, answered_at, expires_at

> **Note**: The Monitoring Agent (MON-009) adds 4 new question types:
>
> - **ALERT**: FYI notification, no action required
> - **ESCALATION**: Tried to fix, need human help
> - **APPROVAL**: Want to take destructive action, need permission
> - **DECISION**: Multiple valid responses, human chooses

2. **Answers Table**:
   - id (UUID)
   - question_id (FK)
   - user_id (FK)
   - answer_text
   - selected_option
   - used_default (boolean)
   - answered_at

3. **Indexes**:
   - Questions by status and priority
   - Questions by agent and session
   - Answers by question

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion             | How to Verify                                                                                          |
| --- | --------------------- | ------------------------------------------------------------------------------------------------------ |
| 1   | Migration file exists | `test -f database/migrations/025_question_queue.sql` returns 0                                         |
| 2   | Has questions table   | `grep -q "CREATE TABLE questions" database/migrations/025_question_queue.sql` returns 0                |
| 3   | Has answers table     | `grep -q "CREATE TABLE answers" database/migrations/025_question_queue.sql` returns 0                  |
| 4   | Has required columns  | `grep -q "type\|priority\|status" database/migrations/025_question_queue.sql` returns 0                |
| 5   | Has monitoring types  | `grep -q "ALERT.*ESCALATION.*APPROVAL.*DECISION" database/migrations/025_question_queue.sql` returns 0 |
| 6   | Has timeout handling  | `grep -q "timeout_ms\|timeout_action" database/migrations/025_question_queue.sql` returns 0            |
| 7   | Has indexes           | `grep -q "CREATE INDEX" database/migrations/025_question_queue.sql` returns 0                          |
| 8   | Migration runs        | `npm run migrate` completes without error                                                              |
| 9   | Schema valid          | `sqlite3 database/ideas.db ".schema questions"` shows table                                            |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/migrations/
└── 025_question_queue.sql
```

---

## Code Template

```sql
-- database/migrations/025_question_queue.sql

CREATE TABLE questions (
  id TEXT PRIMARY KEY,
  agent_id TEXT NOT NULL,
  session_id TEXT,
  -- Original types + Monitoring Agent types (MON-009)
  type TEXT NOT NULL CHECK (type IN (
    'BLOCKING', 'CLARIFYING', 'CONFIRMING', 'PREFERENCE',
    'ALERT', 'ESCALATION', 'APPROVAL', 'DECISION'
  )),
  content TEXT NOT NULL,
  context TEXT, -- JSON
  options TEXT, -- JSON
  default_answer TEXT,
  priority INTEGER DEFAULT 0,
  blocking INTEGER DEFAULT 0, -- 1 if agent is paused waiting
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'answered', 'expired', 'skipped')),
  timeout_ms INTEGER, -- auto-answer after this duration
  timeout_action TEXT, -- action to take on timeout
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  answered_at DATETIME,
  expires_at DATETIME
);

CREATE TABLE answers (
  id TEXT PRIMARY KEY,
  question_id TEXT NOT NULL REFERENCES questions(id),
  user_id TEXT,
  answer_text TEXT,
  selected_option TEXT,
  used_default INTEGER DEFAULT 0,
  answered_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_questions_status_priority ON questions(status, priority DESC);
CREATE INDEX idx_questions_agent_session ON questions(agent_id, session_id);
CREATE INDEX idx_answers_question ON answers(question_id);
```

---

## Validation

```bash
npm run migrate
sqlite3 database/ideas.db ".schema questions"
sqlite3 database/ideas.db ".schema answers"
```
