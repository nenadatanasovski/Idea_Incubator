# UFS-006: Deprecate Database Artifact Storage

---

## Metadata

| Field          | Value                   |
| -------------- | ----------------------- |
| **Phase**      | 2 - Unified File System |
| **Depends On** | UFS-002, UFS-003        |
| **Blocks**     | None                    |
| **Priority**   | P2                      |
| **Owner**      | Human + Claude Code     |

---

## Summary

Remove the deprecated `ideation_artifacts` database table and all code that references it. This completes the migration to file-based artifact storage.

---

## Context

### Migration Checklist

Before deprecation:

- [x] All artifacts migrated to files (UFS-002)
- [x] Artifact store uses files (UFS-003)
- [x] All code paths tested
- [x] Backup created

### Code to Remove/Update

| File                        | Change                                     |
| --------------------------- | ------------------------------------------ |
| `database/migrations/*.sql` | Keep for history, add DROP TABLE migration |
| `utils/artifact-store.ts`   | Remove database code                       |
| `server/routes/*.ts`        | Remove direct artifact queries             |
| `tests/*.test.ts`           | Update to use file-based approach          |

---

## Requirements

1. **Create Deprecation Migration**:
   - Add migration to drop `ideation_artifacts` table
   - Include data verification step
   - Support rollback

2. **Remove Database Code**:
   - Remove artifact table queries
   - Remove database-specific types
   - Update imports

3. **Update Tests**:
   - Remove database artifact tests
   - Add file-based artifact tests
   - Verify coverage maintained

4. **Documentation**:
   - Update CLAUDE.md to reflect file storage
   - Remove references to artifact table
   - Document new storage approach

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion                 | How to Verify                           |
| --- | ------------------------- | --------------------------------------- |
| 1   | Artifact table dropped    | Query `.tables` shows no artifact table |
| 2   | No database artifact code | Grep returns no matches                 |
| 3   | All tests pass            | `npm test` succeeds                     |
| 4   | App functions correctly   | Manual smoke test                       |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/migrations/xxx_drop_artifacts.sql  <- Deprecation migration
CLAUDE.md                                   <- Updated documentation
```

---

## Code Template

### Deprecation Migration

```sql
-- database/migrations/xxx_drop_artifacts.sql
-- Drop deprecated ideation_artifacts table
-- NOTE: Ensure UFS-002 migration completed successfully before running

-- Verify no data remains (should return 0)
-- SELECT COUNT(*) FROM ideation_artifacts;

-- Drop the table
DROP TABLE IF EXISTS ideation_artifacts;

-- Drop any related indexes
DROP INDEX IF EXISTS idx_artifacts_idea;
DROP INDEX IF EXISTS idx_artifacts_session;
```

### Code Cleanup Checklist

```typescript
// Search and remove these patterns:

// 1. Database queries
await query('SELECT * FROM ideation_artifacts ...');
await run('INSERT INTO ideation_artifacts ...');

// 2. Type definitions
interface ArtifactRow { ... }
type DatabaseArtifact = { ... }

// 3. Import statements
import { getArtifacts } from './db/artifacts';

// 4. Test fixtures
const mockArtifactRow = { ... }
```

---

## Validation

```bash
# Verify table is gone
sqlite3 database/ideas.db ".tables" | grep -v "ideation_artifacts"

# Search for remaining references
grep -r "ideation_artifacts" --include="*.ts" .

# Run full test suite
npm test

# Verify app starts
npm run dev
```

---

## Rollback Procedure

If issues are discovered:

```sql
-- Recreate table from backup
CREATE TABLE ideation_artifacts AS SELECT * FROM ideation_artifacts_backup;

-- Or restore from file backup
-- cp database/ideas.db.backup database/ideas.db
```

---

## Next Steps

After completing: Unified File System is complete. Proceed with Ideation System improvements (IDE-\*).
