# WSK-001: WebSocket Server Setup

---

## Metadata

| Field          | Value            |
| -------------- | ---------------- |
| **Phase**      | 4 - Real-Time    |
| **Depends On** | ORC-001          |
| **Blocks**     | WSK-002, WSK-003 |
| **Priority**   | P1               |
| **Owner**      | Build Agent      |

---

## Summary

Set up WebSocket server for real-time communication between agents and web dashboard.

---

## Requirements

1. **Server Setup**:
   - WebSocket server on separate port (or upgrade from HTTP)
   - Handle multiple concurrent connections
   - Authentication/authorization

2. **Message Protocol**:
   - JSON message format
   - Message types: agent_status, question, answer, task_update
   - Message acknowledgment

3. **Error Handling**:
   - Connection errors
   - Message parsing errors
   - Authentication failures

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion           | How to Verify                                                 |
| --- | ------------------- | ------------------------------------------------------------- |
| 1   | Server file exists  | `test -f server/websocket/server.ts` returns 0                |
| 2   | Uses ws library     | `grep -q "ws" server/websocket/server.ts` returns 0           |
| 3   | Has message handler | `grep -q "onMessage" server/websocket/server.ts` returns 0    |
| 4   | Has auth middleware | `grep -q "authenticate" server/websocket/server.ts` returns 0 |
| 5   | Server starts       | `npm run ws:start` starts without error                       |
| 6   | Accepts connection  | Manual test: wscat can connect                                |
| 7   | TypeScript compiles | `npx tsc --noEmit server/websocket/server.ts` returns 0       |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/websocket/
├── server.ts
├── handlers.ts
├── protocol.ts
└── auth.ts
```

---

## Code Template

```typescript
// server/websocket/server.ts

import { WebSocketServer, WebSocket } from "ws";

export interface WSMessage {
  type: "agent_status" | "question" | "answer" | "task_update";
  payload: unknown;
  id: string;
  timestamp: Date;
}

export class VibeWebSocketServer {
  private wss: WebSocketServer;
  private clients: Map<string, WebSocket>;

  constructor(port: number) {
    this.wss = new WebSocketServer({ port });
    this.clients = new Map();
    this.setupHandlers();
  }

  private setupHandlers(): void {
    this.wss.on("connection", (ws, req) => {
      // Auth and register client
    });
  }

  broadcast(message: WSMessage): void {
    // Send to all clients
  }
}
```

---

## Validation

```bash
npx tsc --noEmit server/websocket/server.ts
npm run ws:start &
wscat -c ws://localhost:3001 && echo "Connection OK"
```
