# VAL-005: Coverage Analyzer

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 8 - Validation Agent |
| **Depends On** | VAL-004 |
| **Blocks** | None |
| **Priority** | P2 |
| **Owner** | Human + Claude Code |

---

## Summary

Implement a coverage analyzer validator that checks code coverage meets the required thresholds. Uses Vitest's V8 coverage reporter and analyzes coverage data.

---

## Context

### Coverage Metrics

| Metric | Description | Typical Threshold |
|--------|-------------|-------------------|
| **Lines** | % of lines executed | 80% |
| **Branches** | % of branches taken | 70% |
| **Functions** | % of functions called | 80% |
| **Statements** | % of statements executed | 80% |

### Coverage Report Format

```typescript
interface CoverageReport {
  total: {
    lines: CoverageMetric;
    branches: CoverageMetric;
    functions: CoverageMetric;
    statements: CoverageMetric;
  };
  files: Record<string, FileCoverage>;
}

interface CoverageMetric {
  covered: number;
  total: number;
  percentage: number;
}
```

---

## Requirements

1. **Coverage Execution**:
   - Run Vitest with coverage enabled
   - Output JSON coverage report
   - Parse coverage data

2. **Threshold Checking**:
   - Compare against level thresholds
   - Support per-metric thresholds
   - Identify uncovered files

3. **Reporting**:
   - Overall coverage summary
   - Per-file coverage breakdown
   - Uncovered lines list

4. **Integration**:
   - Register as validator
   - Support configuration
   - Include in THOROUGH+ levels

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | Coverage collected | Run and check report |
| 2 | Thresholds enforced | Fail on low coverage |
| 3 | Details available | File-level breakdown |
| 4 | Uncovered identified | List of uncovered lines |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/validation/validators/coverage-analyzer.ts
```

---

## Code Template

```typescript
// agents/validation/validators/coverage-analyzer.ts

import { ValidatorResult, Validator } from '../types';

export class CoverageAnalyzer implements Validator {
  name = 'coverage';

  async validate(options: ValidatorOptions): Promise<ValidatorResult> {
    const startTime = Date.now();

    try {
      // Run tests with coverage
      await this.runWithCoverage();

      // Read coverage report
      const report = await this.readCoverageReport();

      // Check thresholds
      const passed = this.checkThresholds(report, options.thresholds);

      return {
        validator: this.name,
        passed,
        duration: Date.now() - startTime,
        details: {
          lines: report.total.lines.percentage,
          branches: report.total.branches.percentage,
          functions: report.total.functions.percentage,
          statements: report.total.statements.percentage,
          uncovered: this.findUncoveredFiles(report)
        }
      };
    } catch (error) {
      return {
        validator: this.name,
        passed: false,
        duration: Date.now() - startTime,
        error: error.message
      };
    }
  }

  private checkThresholds(
    report: CoverageReport,
    thresholds: CoverageThresholds
  ): boolean {
    const { lines, branches, functions, statements } = report.total;

    if (thresholds.lines && lines.percentage < thresholds.lines) return false;
    if (thresholds.branches && branches.percentage < thresholds.branches) return false;
    if (thresholds.functions && functions.percentage < thresholds.functions) return false;
    if (thresholds.statements && statements.percentage < thresholds.statements) return false;

    return true;
  }

  private findUncoveredFiles(report: CoverageReport): string[] {
    return Object.entries(report.files)
      .filter(([_, cov]) => cov.lines.percentage < 50)
      .map(([file]) => file);
  }
}
```

---

## Validation

```bash
# Run coverage validator
npm run validate -- --validator coverage

# Check threshold enforcement
npm run validate -- --level THOROUGH  # Requires 70% coverage

# View detailed report
cat coverage/coverage-summary.json | jq
```

---

## Next Steps

After completing: Implement security scanner (VAL-006).
