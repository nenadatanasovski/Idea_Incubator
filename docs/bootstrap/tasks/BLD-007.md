# BLD-007: Checkpoint Manager

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 2 - Build Agent |
| **Depends On** | BLD-003 |
| **Blocks** | None |
| **Priority** | P2 |
| **Owner** | Human (then Build Agent) |

---

## Summary

Save and restore build progress, enabling resume after interruption or failure.

---

## Requirements

1. **Checkpoint Creation**:
   - Save after each task completion
   - Include task states and outputs
   - Store file hashes for change detection

2. **Restore Logic**:
   - Detect existing checkpoint
   - Validate checkpoint integrity
   - Resume from last good state

3. **Cleanup**:
   - Remove old checkpoints
   - Keep configurable history
   - Handle corrupted checkpoints

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | File exists | `test -f agents/build/checkpoint-manager.ts` returns 0 |
| 2 | Exports CheckpointManager | `grep -q "export class CheckpointManager" agents/build/checkpoint-manager.ts` returns 0 |
| 3 | Has save method | `grep -q "save(" agents/build/checkpoint-manager.ts` returns 0 |
| 4 | Has restore method | `grep -q "restore(" agents/build/checkpoint-manager.ts` returns 0 |
| 5 | Has cleanup method | `grep -q "cleanup(" agents/build/checkpoint-manager.ts` returns 0 |
| 6 | TypeScript compiles | `npx tsc --noEmit agents/build/checkpoint-manager.ts` returns 0 |
| 7 | Unit tests pass | `npm test -- --grep "checkpoint-manager"` passes |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/build/
└── checkpoint-manager.ts
```

---

## Code Template

```typescript
// agents/build/checkpoint-manager.ts

export interface Checkpoint {
  specId: string;
  timestamp: Date;
  taskStates: Record<string, TaskState>;
  taskOutputs: Record<string, string>;
  fileHashes: Record<string, string>;
}

export class CheckpointManager {
  async save(specId: string, state: BuildState): Promise<void> {
    // Persist checkpoint
  }

  async restore(specId: string): Promise<Checkpoint | null> {
    // Load and validate checkpoint
  }

  async cleanup(specId: string, keepLast: number = 3): Promise<void> {
    // Remove old checkpoints
  }
}
```

---

## Validation

```bash
npx tsc --noEmit agents/build/checkpoint-manager.ts
npm test -- --grep "checkpoint-manager"
```
