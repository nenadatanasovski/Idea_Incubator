# WSK-002: Client Connection Management

---

## Metadata

| Field          | Value         |
| -------------- | ------------- |
| **Phase**      | 4 - Real-Time |
| **Depends On** | WSK-001       |
| **Blocks**     | WSK-003       |
| **Priority**   | P1            |
| **Owner**      | Build Agent   |

---

## Summary

Manage WebSocket client connections including tracking, cleanup, and client-side reconnection.

---

## Requirements

1. **Server-Side**:
   - Track active connections
   - Associate connections with users
   - Clean up on disconnect
   - Handle multiple tabs/devices

2. **Client-Side Hook**:
   - React hook for WebSocket connection
   - Auto-reconnect on disconnect
   - Connection state management
   - Message queue during reconnect

3. **Health Monitoring**:
   - Ping/pong heartbeat
   - Detect stale connections
   - Force reconnect on timeout

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion             | How to Verify                                                                |
| --- | --------------------- | ---------------------------------------------------------------------------- |
| 1   | Server manager exists | `test -f server/websocket/connection-manager.ts` returns 0                   |
| 2   | Client hook exists    | `test -f web/src/hooks/useWebSocket.ts` returns 0                            |
| 3   | Has reconnect logic   | `grep -q "reconnect" web/src/hooks/useWebSocket.ts` returns 0                |
| 4   | Has heartbeat         | `grep -q "ping\|heartbeat" server/websocket/connection-manager.ts` returns 0 |
| 5   | Tracks connections    | `grep -q "connections" server/websocket/connection-manager.ts` returns 0     |
| 6   | TypeScript compiles   | `npx tsc --noEmit server/websocket/*.ts` returns 0                           |
| 7   | Auto-reconnect works  | Manual test: disconnect and reconnect in < 5s                                |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/websocket/
└── connection-manager.ts

web/src/hooks/
└── useWebSocket.ts
```

---

## Code Template

```typescript
// web/src/hooks/useWebSocket.ts

export function useWebSocket(url: string) {
  const [socket, setSocket] = useState<WebSocket | null>(null);
  const [status, setStatus] = useState<
    "connecting" | "connected" | "disconnected"
  >("connecting");

  useEffect(() => {
    // Connect and setup reconnect
  }, [url]);

  const send = useCallback(
    (message: WSMessage) => {
      // Send or queue if disconnected
    },
    [socket],
  );

  return { socket, status, send };
}
```

---

## Validation

```bash
npx tsc --noEmit server/websocket/connection-manager.ts
cd web && npm run build
```
