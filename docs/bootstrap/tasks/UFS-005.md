# UFS-005: File Watcher for Sync

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 2 - Unified File System |
| **Depends On** | UFS-003 |
| **Blocks** | None |
| **Priority** | P3 |
| **Owner** | Human + Claude Code |

---

## Summary

Implement a file watcher that monitors the idea folders for changes and synchronizes metadata to the database. This enables real-time updates in the UI when files are edited externally.

---

## Context

### Why File Watching?

| Scenario | Without Watcher | With Watcher |
|----------|-----------------|--------------|
| User edits file in VS Code | UI shows stale data | UI updates automatically |
| Git pull brings new files | Manual sync required | Auto-discovered |
| CI generates artifacts | Database out of sync | Database updated |

### Watcher Events

| Event | Action |
|-------|--------|
| `add` | Create database record |
| `change` | Update database record |
| `unlink` | Delete database record |
| `addDir` | Discover new idea folder |
| `unlinkDir` | Mark idea as archived |

---

## Requirements

1. **File Watcher Setup**:
   - Watch `users/` directory recursively
   - Ignore `node_modules`, `.git`, temp files
   - Debounce rapid changes

2. **Change Detection**:
   - Detect file content changes
   - Detect file renames
   - Handle batch changes (e.g., git checkout)

3. **Database Sync**:
   - Update ideas table with file metadata
   - Update modified timestamps
   - Maintain content hashes for change detection

4. **WebSocket Broadcast**:
   - Notify connected clients of changes
   - Include changed file path and type
   - Support selective subscriptions

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | Watcher starts without errors | Check console on server start |
| 2 | File changes detected | Edit file, see log message |
| 3 | Database updated | Query database after change |
| 4 | WebSocket notifies clients | Connect client, verify message |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/services/file-watcher.ts  <- Watcher implementation
server/services/sync-service.ts  <- Database sync logic
tests/file-watcher.test.ts       <- Unit tests
```

---

## Code Template

```typescript
// server/services/file-watcher.ts

import chokidar from 'chokidar';
import { debounce } from 'lodash';
import { syncFileToDatabase, removeFromDatabase } from './sync-service';
import { broadcastChange } from '../websocket';

const WATCH_PATH = 'users';
const IGNORE_PATTERNS = [
  '**/node_modules/**',
  '**/.git/**',
  '**/.*',
  '**/*.tmp'
];

export class FileWatcher {
  private watcher: chokidar.FSWatcher | null = null;

  start(): void {
    this.watcher = chokidar.watch(WATCH_PATH, {
      ignored: IGNORE_PATTERNS,
      persistent: true,
      ignoreInitial: true,
      awaitWriteFinish: {
        stabilityThreshold: 500,
        pollInterval: 100
      }
    });

    const handleChange = debounce(async (path: string) => {
      console.log(`[FileWatcher] Changed: ${path}`);
      await syncFileToDatabase(path);
      broadcastChange({ type: 'file_changed', path });
    }, 300);

    this.watcher
      .on('add', handleChange)
      .on('change', handleChange)
      .on('unlink', async (path) => {
        console.log(`[FileWatcher] Deleted: ${path}`);
        await removeFromDatabase(path);
        broadcastChange({ type: 'file_deleted', path });
      })
      .on('error', (error) => {
        console.error('[FileWatcher] Error:', error);
      });

    console.log(`[FileWatcher] Watching ${WATCH_PATH}/...`);
  }

  stop(): void {
    if (this.watcher) {
      this.watcher.close();
      this.watcher = null;
    }
  }
}
```

---

## Validation

```bash
# Start server with watcher enabled
npm run dev

# In another terminal, modify a file
echo "test" >> users/default/ideas/test/README.md

# Check logs for watcher output
# Check database for updated timestamp
# Check WebSocket client for notification
```

---

## Next Steps

After completing: Deprecate database artifact storage (UFS-006).
