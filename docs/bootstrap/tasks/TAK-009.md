# TAK-009: DeduplicationEngine Service

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 3 - Core Services |
| **Depends On** | TAK-007 |
| **Blocks** | TAK-016 (TaskAgent) |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Implement the DeduplicationEngine class that detects similar or duplicate tasks using embeddings and cosine similarity.

---

## Requirements

1. **DeduplicationEngine class**:
   - Generate embeddings for task title+description
   - Query similar tasks using vector similarity
   - Classify as duplicate/overlapping/related/distinct
   - Suggest merge or link actions
   - Store embeddings in task record

2. **Methods**:
   - `checkDuplicates(task: Task): Promise<DuplicateResult>`
   - `generateEmbedding(text: string): Promise<number[]>`
   - `findSimilar(embedding, threshold): Promise<Task[]>`
   - `classifyRelationship(similarity): RelationType`

3. **Thresholds**:
   - >0.95: duplicate_of
   - >0.85: overlapping
   - >0.70: related_to
   - <0.70: distinct

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | File exists | `test -f server/services/task-agent/deduplication-engine.ts` returns 0 |
| 2 | Exports DeduplicationEngine | `grep -q "export class DeduplicationEngine" server/services/task-agent/deduplication-engine.ts` returns 0 |
| 3 | Has checkDuplicates | `grep -q "checkDuplicates" server/services/task-agent/deduplication-engine.ts` returns 0 |
| 4 | Has generateEmbedding | `grep -q "generateEmbedding" server/services/task-agent/deduplication-engine.ts` returns 0 |
| 5 | TypeScript compiles | `npx tsc --noEmit server/services/task-agent/deduplication-engine.ts` returns 0 |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/services/task-agent/
└── deduplication-engine.ts
```

---

## Gotchas

- Use cosine similarity for embeddings
- Cache embeddings to avoid regeneration
- Store embeddings as BLOB in task record

---

## Validation

```bash
npx tsc --noEmit server/services/task-agent/deduplication-engine.ts
npm test -- --grep "deduplication"
```

---

## Next Steps

After completing: Implement ClassificationEngine (TAK-010).
