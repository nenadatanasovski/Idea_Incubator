# TAK-021: Task Agent WebSocket Events

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 6 - WebSocket Events |
| **Depends On** | TAK-016 |
| **Blocks** | TAK-022 (Frontend Dashboard) |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Add task-agent event handlers to server/websocket.ts for real-time updates to connected clients.

---

## Context

### WebSocket Events

| Event | Description |
|-------|-------------|
| task:created | New task created |
| task:updated | Task details changed |
| task:deleted | Task deleted |
| task:status_changed | Task status transition |
| task:blocked | Task became blocked |
| task:unblocked | Task unblocked |
| task:validation_passed | Task passed validation |
| task:validation_failed | Task failed validation |
| task:test_started | Test execution started |
| task:test_passed | Tests passed |
| task:test_failed | Tests failed |
| task:duplicate_detected | Similar task found |
| task:completion_detected | Completion signals detected |

---

## Requirements

1. **Update server/websocket.ts**:
   - Add task-agent event handlers
   - Add taskAgentClients set for subscriptions
   - Implement task:* event broadcasting
   - Add URL parameter support (?monitor=tasks)

2. **Client Subscription**:
   - Connect with `?monitor=tasks` to receive task events
   - Clients automatically receive all task:* events

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | Has task events | `grep -q "task:created\|task:updated" server/websocket.ts` returns 0 |
| 2 | Has monitor param | `grep -q "monitor.*tasks\|tasks.*monitor" server/websocket.ts` returns 0 |
| 3 | Has taskAgentClients | `grep -q "taskAgentClients\|taskClients" server/websocket.ts` returns 0 |
| 4 | TypeScript compiles | `npx tsc --noEmit server/websocket.ts` returns 0 |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/
└── websocket.ts (UPDATE)
```

---

## Validation

```bash
npx tsc --noEmit server/websocket.ts
# Test WebSocket connection
wscat -c "ws://localhost:3001/ws?monitor=tasks"
```

---

## Next Steps

After completing: Create frontend dashboard (TAK-022).
