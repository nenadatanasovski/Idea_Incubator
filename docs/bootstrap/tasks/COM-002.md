# COM-002: Bot Registry and Token Management

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 0 - Communication Core |
| **Depends On** | COM-001, FND-002 |
| **Blocks** | COM-004, COM-005 |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Implement the Bot Registry that manages multiple Telegram bot tokens, validates them on startup, and provides the correct bot for each agent type.

---

## Requirements

1. **Bot Registry**:
   - Load all bot tokens from environment
   - Validate tokens on startup (call getMe)
   - Map agent types to bots
   - Provide getBot(agentType) method

2. **Agent Type Mapping**:
   - monitoring → MONITOR bot
   - orchestrator → ORCHESTRATOR bot
   - spec → SPEC bot
   - build → BUILD bot
   - validation → VALIDATION bot
   - sia → SIA bot
   - * (fallback) → SYSTEM bot

3. **Health Checking**:
   - Periodic validation (every 5 min)
   - Report unhealthy bots
   - Fallback to SYSTEM bot if specific bot fails

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | File exists | `test -f server/communication/bot-registry.ts` returns 0 |
| 2 | Exports BotRegistry | `grep -q "export class BotRegistry" server/communication/bot-registry.ts` returns 0 |
| 3 | Has getBot method | `grep -q "getBot(" server/communication/bot-registry.ts` returns 0 |
| 4 | Validates tokens | `grep -q "validateToken\|getMe" server/communication/bot-registry.ts` returns 0 |
| 5 | Has fallback logic | `grep -q "fallback\|SYSTEM" server/communication/bot-registry.ts` returns 0 |
| 6 | TypeScript compiles | `npx tsc --noEmit server/communication/bot-registry.ts` returns 0 |
| 7 | Unit tests pass | `npm test -- --grep "bot-registry"` passes |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/communication/
├── bot-registry.ts      ← PRIMARY OUTPUT
├── types.ts             ← Shared types
└── config.ts            ← Configuration loader
```

---

## Code Template

```typescript
// server/communication/bot-registry.ts

import { TelegramBot } from './types';

export type AgentType =
  | 'monitoring'
  | 'orchestrator'
  | 'spec'
  | 'build'
  | 'validation'
  | 'sia'
  | 'system';

interface BotConfig {
  agentType: AgentType;
  envVar: string;
  displayName: string;
}

const BOT_CONFIGS: BotConfig[] = [
  { agentType: 'monitoring', envVar: 'TELEGRAM_BOT_TOKEN_MONITOR', displayName: 'Vibe Monitor' },
  { agentType: 'orchestrator', envVar: 'TELEGRAM_BOT_TOKEN_ORCHESTRATOR', displayName: 'Vibe Orchestrator' },
  { agentType: 'spec', envVar: 'TELEGRAM_BOT_TOKEN_SPEC', displayName: 'Vibe Spec' },
  { agentType: 'build', envVar: 'TELEGRAM_BOT_TOKEN_BUILD', displayName: 'Vibe Build' },
  { agentType: 'validation', envVar: 'TELEGRAM_BOT_TOKEN_VALIDATION', displayName: 'Vibe Validation' },
  { agentType: 'sia', envVar: 'TELEGRAM_BOT_TOKEN_SIA', displayName: 'Vibe SIA' },
  { agentType: 'system', envVar: 'TELEGRAM_BOT_TOKEN_SYSTEM', displayName: 'Vibe System' },
];

export interface RegisteredBot {
  agentType: AgentType;
  token: string;
  botId: number;
  username: string;
  displayName: string;
  healthy: boolean;
  lastChecked: Date;
}

export class BotRegistry {
  private bots: Map<AgentType, RegisteredBot> = new Map();
  private healthCheckInterval: ReturnType<typeof setInterval> | null = null;

  async initialize(): Promise<void> {
    for (const config of BOT_CONFIGS) {
      const token = process.env[config.envVar];

      if (!token) {
        console.warn(`Missing token for ${config.agentType}: ${config.envVar}`);
        continue;
      }

      const botInfo = await this.validateToken(token);

      if (botInfo) {
        this.bots.set(config.agentType, {
          agentType: config.agentType,
          token,
          botId: botInfo.id,
          username: botInfo.username,
          displayName: config.displayName,
          healthy: true,
          lastChecked: new Date(),
        });
      }
    }

    // Start health checks
    this.startHealthChecks();
  }

  getBot(agentType: AgentType): RegisteredBot | null {
    const bot = this.bots.get(agentType);

    if (bot?.healthy) {
      return bot;
    }

    // Fallback to system bot
    const systemBot = this.bots.get('system');
    if (systemBot?.healthy) {
      console.warn(`Using system bot as fallback for ${agentType}`);
      return systemBot;
    }

    return null;
  }

  getBotForAgent(agentId: string): RegisteredBot | null {
    // Extract agent type from agent ID (e.g., "spec-agent-123" → "spec")
    const agentType = this.extractAgentType(agentId);
    return this.getBot(agentType);
  }

  getAllBots(): RegisteredBot[] {
    return Array.from(this.bots.values());
  }

  getHealthyBots(): RegisteredBot[] {
    return this.getAllBots().filter(b => b.healthy);
  }

  private async validateToken(token: string): Promise<{ id: number; username: string } | null> {
    try {
      const response = await fetch(`https://api.telegram.org/bot${token}/getMe`);
      const data = await response.json();

      if (data.ok) {
        return {
          id: data.result.id,
          username: data.result.username,
        };
      }
      return null;
    } catch (error) {
      console.error('Failed to validate bot token:', error);
      return null;
    }
  }

  private startHealthChecks(): void {
    this.healthCheckInterval = setInterval(async () => {
      for (const [agentType, bot] of this.bots) {
        const info = await this.validateToken(bot.token);
        bot.healthy = info !== null;
        bot.lastChecked = new Date();

        if (!bot.healthy) {
          console.error(`Bot ${agentType} is unhealthy`);
        }
      }
    }, 5 * 60 * 1000); // Every 5 minutes
  }

  private extractAgentType(agentId: string): AgentType {
    if (agentId.includes('monitor')) return 'monitoring';
    if (agentId.includes('orchestrat')) return 'orchestrator';
    if (agentId.includes('spec')) return 'spec';
    if (agentId.includes('build')) return 'build';
    if (agentId.includes('valid')) return 'validation';
    if (agentId.includes('sia')) return 'sia';
    return 'system';
  }

  stop(): void {
    if (this.healthCheckInterval) {
      clearInterval(this.healthCheckInterval);
    }
  }
}
```

---

## Validation

```bash
npx tsc --noEmit server/communication/bot-registry.ts
npm test -- --grep "bot-registry"
```
