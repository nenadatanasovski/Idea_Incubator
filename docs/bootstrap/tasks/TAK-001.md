# TAK-001: Tasks Schema Migration

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 1 - Database Schema |
| **Depends On** | FND-002 |
| **Blocks** | TAK-002, TAK-003, TAK-004, TAK-005, TAK-006, TAK-006a, TAK-006b, TAK-007 |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Create the main tasks table migration for the Task Agent. This is the foundational table that stores all task information including validation status, blocking reasons, test cases, and embeddings.

---

## Context

### Why This Task?

| Benefit | Description |
|---------|-------------|
| **Foundation** | All Task Agent services depend on this schema |
| **Validation Gate** | Stores validation_status and blocking columns |
| **Test Cases** | JSON columns for API and UI test cases |
| **Deduplication** | Embedding column for similarity search |

### Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| TEXT for dates | SQLite doesn't have native DATETIME |
| JSON as TEXT | SQLite stores JSON in TEXT columns |
| BLOB for embeddings | Binary format for vector embeddings |
| 16 task categories | Per task-data-model.md specification |

---

## Requirements

1. **Create tasks table**:
   - All required fields from task-data-model.md
   - Include validation_status and blocking columns
   - Add embedding column for similarity search (BLOB)
   - Include project_id, idea_slug, parent_id relationships
   - Add acceptance_criteria, api_test_cases, ui_test_cases as JSON

2. **Create indexes**:
   - idx_tasks_status on status
   - idx_tasks_category on category
   - idx_tasks_project on project_id
   - idx_tasks_parent on parent_id

3. **Follow conventions**:
   - Use TEXT for dates (ISO-8601 format)
   - Use `IF NOT EXISTS` for idempotency
   - Use `datetime('now')` for default timestamps

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | Migration file exists | `test -f database/migrations/050_tasks_schema.sql` returns 0 |
| 2 | Has tasks table | `grep -q "CREATE TABLE IF NOT EXISTS tasks" database/migrations/050_tasks_schema.sql` returns 0 |
| 3 | Has validation columns | `grep -q "validation_status" database/migrations/050_tasks_schema.sql` returns 0 |
| 4 | Has embedding column | `grep -q "embedding BLOB" database/migrations/050_tasks_schema.sql` returns 0 |
| 5 | Has test case columns | `grep -q "api_test_cases" database/migrations/050_tasks_schema.sql` returns 0 |
| 6 | Has indexes | `grep -q "CREATE INDEX" database/migrations/050_tasks_schema.sql` returns 0 |
| 7 | Migration runs | `sqlite3 :memory: < database/migrations/050_tasks_schema.sql && echo 'OK'` returns "OK" |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/migrations/
└── 050_tasks_schema.sql
```

---

## Code Template

```sql
-- Migration 050: Tasks schema for Task Agent
-- Created: 2026-01-12

CREATE TABLE IF NOT EXISTS tasks (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  category TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'draft',
  priority INTEGER DEFAULT 50,

  -- Relationships
  parent_id TEXT REFERENCES tasks(id),
  project_id TEXT NOT NULL,
  idea_slug TEXT,

  -- Validation
  acceptance_criteria TEXT,  -- JSON array
  api_test_cases TEXT,       -- JSON array
  ui_test_cases TEXT,        -- JSON array
  validation_command TEXT,
  validation_status TEXT DEFAULT 'pending',
  validation_issues TEXT,    -- JSON array
  blocking_reason TEXT,

  -- Execution
  assigned_agent TEXT,
  estimated_effort TEXT,
  actual_effort_minutes INTEGER,

  -- Embeddings
  embedding BLOB,
  embedding_model TEXT,

  -- Metadata
  created_by TEXT NOT NULL,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now')),
  started_at TEXT,
  completed_at TEXT
);

CREATE INDEX IF NOT EXISTS idx_tasks_status ON tasks(status);
CREATE INDEX IF NOT EXISTS idx_tasks_category ON tasks(category);
CREATE INDEX IF NOT EXISTS idx_tasks_project ON tasks(project_id);
CREATE INDEX IF NOT EXISTS idx_tasks_parent ON tasks(parent_id);
```

---

## Gotchas

- Use TEXT for dates in SQLite, not DATETIME
- Always include IF NOT EXISTS for idempotent migrations
- JSON columns stored as TEXT in SQLite
- Foreign keys require `PRAGMA foreign_keys = ON` to enforce

---

## Validation

```bash
# Create migration and test it
sqlite3 :memory: < database/migrations/050_tasks_schema.sql

# Run migration
npm run migrate

# Verify table exists
sqlite3 database/ideas.db ".schema tasks"
```

---

## Next Steps

After completing: Create task_relationships table (TAK-002).
