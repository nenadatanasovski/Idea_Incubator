# WSK-003: Event Broadcasting

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 4 - Real-Time |
| **Depends On** | WSK-002 |
| **Blocks** | WEB-002 |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Broadcast events from agents to connected clients in real-time.

---

## Requirements

1. **Event Types**:
   - agent_status_change
   - new_question
   - question_answered
   - task_started
   - task_completed
   - task_failed

2. **Targeted Broadcasting**:
   - Broadcast to all clients
   - Send to specific user
   - Send to clients subscribed to topic

3. **Event Bus Integration**:
   - Subscribe to internal event bus
   - Transform events for WebSocket
   - Handle event ordering

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | Broadcaster exists | `test -f server/websocket/broadcaster.ts` returns 0 |
| 2 | Has 6 event types | `grep -c "agent_status\|new_question\|question_answered\|task_" server/websocket/broadcaster.ts` >= 6 |
| 3 | Has broadcast method | `grep -q "broadcast(" server/websocket/broadcaster.ts` returns 0 |
| 4 | Has sendToUser method | `grep -q "sendToUser(" server/websocket/broadcaster.ts` returns 0 |
| 5 | Integrates with event bus | `grep -q "eventBus\|subscribe" server/websocket/broadcaster.ts` returns 0 |
| 6 | TypeScript compiles | `npx tsc --noEmit server/websocket/broadcaster.ts` returns 0 |
| 7 | Events received by client | Manual test: trigger event, verify client receives |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/websocket/
└── broadcaster.ts
```

---

## Code Template

```typescript
// server/websocket/broadcaster.ts

export type EventType =
  | 'agent_status_change'
  | 'new_question'
  | 'question_answered'
  | 'task_started'
  | 'task_completed'
  | 'task_failed';

export interface BroadcastEvent {
  type: EventType;
  payload: unknown;
  timestamp: Date;
}

export class EventBroadcaster {
  constructor(private connectionManager: ConnectionManager) {
    this.subscribeToEventBus();
  }

  broadcast(event: BroadcastEvent): void {
    // Send to all connected clients
  }

  sendToUser(userId: string, event: BroadcastEvent): void {
    // Send to specific user
  }

  private subscribeToEventBus(): void {
    // Listen for internal events
  }
}
```

---

## Validation

```bash
npx tsc --noEmit server/websocket/broadcaster.ts
# Manual: trigger agent status change, verify dashboard updates
```
