# BLD-005: File Writer with Locking

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 2 - Build Agent |
| **Depends On** | BLD-004 |
| **Blocks** | BLD-006 |
| **Priority** | P1 |
| **Owner** | Human (then Build Agent) |

---

## Summary

Write generated code to files with locking to prevent conflicts, backup creation, and atomic writes.

---

## Requirements

1. **Safe Writing**:
   - Acquire lock before writing
   - Create backup before overwriting
   - Atomic write (temp file + rename)

2. **Directory Management**:
   - Create directories as needed
   - Respect project structure
   - Handle path normalization

3. **Conflict Detection**:
   - Check for external modifications
   - Warn on unexpected changes
   - Support merge where possible

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | File exists | `test -f agents/build/file-writer.ts` returns 0 |
| 2 | Exports FileWriter | `grep -q "export class FileWriter" agents/build/file-writer.ts` returns 0 |
| 3 | Has write method | `grep -q "write(" agents/build/file-writer.ts` returns 0 |
| 4 | Has locking | `grep -q "lock" agents/build/file-writer.ts` returns 0 |
| 5 | Has backup | `grep -q "backup" agents/build/file-writer.ts` returns 0 |
| 6 | TypeScript compiles | `npx tsc --noEmit agents/build/file-writer.ts` returns 0 |
| 7 | Unit tests pass | `npm test -- --grep "file-writer"` passes |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/build/
└── file-writer.ts
```

---

## Code Template

```typescript
// agents/build/file-writer.ts

export interface WriteResult {
  path: string;
  success: boolean;
  backupPath?: string;
  error?: string;
}

export class FileWriter {
  async write(path: string, content: string): Promise<WriteResult> {
    // Acquire lock, backup, atomic write
  }

  async acquireLock(path: string): Promise<boolean> {
    // File-based locking
  }

  async releaseLock(path: string): Promise<void> {
    // Release lock
  }

  private createBackup(path: string): Promise<string> {
    // Copy to .backup directory
  }
}
```

---

## Validation

```bash
npx tsc --noEmit agents/build/file-writer.ts
npm test -- --grep "file-writer"
```
