# TAK-012: LifecycleManager Service

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 3 - Core Services |
| **Depends On** | TAK-003, TAK-007 |
| **Blocks** | TAK-016 (TaskAgent) |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Implement the TaskLifecycleManager class that manages task state transitions, enforces valid transitions, and records state history.

---

## Context

### Valid State Transitions

```
draft → pending (after validation passes)
pending → in_progress (when execution starts)
pending → blocked (when dependency blocks)
in_progress → validating (when code complete)
validating → completed (when tests pass)
validating → failed (when tests fail)
blocked → pending (when blocker resolves)
* → cancelled (manual cancellation)
* → stale (no progress for 7 days)
```

---

## Requirements

1. **TaskLifecycleManager class**:
   - Manage state transitions with validation
   - Enforce valid state transitions only
   - Record state history in task_state_history
   - Check dependencies before allowing start
   - Publish events on state changes

2. **Methods**:
   - `transition(taskId, toStatus, reason): Promise<boolean>`
   - `canTransition(fromStatus, toStatus): boolean`
   - `recordHistory(taskId, from, to, reason, actor): Promise<void>`
   - `checkDependencies(taskId): Promise<BlockingDep[]>`

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | File exists | `test -f server/services/task-agent/lifecycle-manager.ts` returns 0 |
| 2 | Exports TaskLifecycleManager | `grep -q "export class TaskLifecycleManager" server/services/task-agent/lifecycle-manager.ts` returns 0 |
| 3 | Has transition method | `grep -q "async transition" server/services/task-agent/lifecycle-manager.ts` returns 0 |
| 4 | Has canTransition | `grep -q "canTransition" server/services/task-agent/lifecycle-manager.ts` returns 0 |
| 5 | Records history | `grep -q "recordHistory" server/services/task-agent/lifecycle-manager.ts` returns 0 |
| 6 | TypeScript compiles | `npx tsc --noEmit server/services/task-agent/lifecycle-manager.ts` returns 0 |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/services/task-agent/
└── lifecycle-manager.ts
```

---

## Validation

```bash
npx tsc --noEmit server/services/task-agent/lifecycle-manager.ts
npm test -- --grep "lifecycle"
```

---

## Next Steps

After completing: Implement DependencyManager (TAK-013).
