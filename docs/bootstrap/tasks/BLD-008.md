# BLD-008: Retry Logic

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 2 - Build Agent |
| **Depends On** | BLD-006 |
| **Blocks** | None |
| **Priority** | P2 |
| **Owner** | Human (then Build Agent) |

---

## Summary

Implement intelligent retry logic that adjusts approach based on failure type.

---

## Requirements

1. **Retry Strategy**:
   - Exponential backoff for transient failures
   - Regeneration with feedback for code errors
   - Escalation after max retries

2. **Failure Classification**:
   - Syntax errors (regenerate)
   - Logic errors (regenerate with hints)
   - Environment errors (retry after delay)
   - Configuration errors (escalate)

3. **Learning**:
   - Track failure patterns
   - Adjust prompts based on common failures
   - Report patterns to SIA

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | File exists | `test -f agents/build/retry-logic.ts` returns 0 |
| 2 | Exports RetryHandler | `grep -q "export class RetryHandler" agents/build/retry-logic.ts` returns 0 |
| 3 | Has shouldRetry method | `grep -q "shouldRetry(" agents/build/retry-logic.ts` returns 0 |
| 4 | Has classifyFailure | `grep -q "classifyFailure(" agents/build/retry-logic.ts` returns 0 |
| 5 | Has exponential backoff | `grep -q "backoff" agents/build/retry-logic.ts` returns 0 |
| 6 | TypeScript compiles | `npx tsc --noEmit agents/build/retry-logic.ts` returns 0 |
| 7 | Unit tests pass | `npm test -- --grep "retry-logic"` passes |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/build/
└── retry-logic.ts
```

---

## Code Template

```typescript
// agents/build/retry-logic.ts

export type FailureType = 'syntax' | 'logic' | 'environment' | 'configuration';

export interface RetryDecision {
  shouldRetry: boolean;
  strategy: 'regenerate' | 'retry' | 'escalate';
  delay: number;
  feedback?: string;
}

export class RetryHandler {
  shouldRetry(error: Error, attempts: number): RetryDecision {
    // Decide retry strategy
  }

  classifyFailure(error: Error): FailureType {
    // Categorize the error
  }

  calculateBackoff(attempts: number): number {
    // Exponential backoff with jitter
  }
}
```

---

## Validation

```bash
npx tsc --noEmit agents/build/retry-logic.ts
npm test -- --grep "retry-logic"
```
