# MON-002: Event Bus Listener (Primary Data Source)

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 2 - Monitoring Agent |
| **Depends On** | MON-001, ORC-001 |
| **Blocks** | MON-004 |
| **Priority** | P1 |
| **Owner** | Human (then Build Agent) |

---

## Summary

Implement the Event Bus Listener that provides the primary, authoritative data source for agent states. Real-time, typed events with millisecond latency.

---

## Requirements

1. **Event Subscription**:
   - Subscribe to all agent events (agent_started, agent_stopped, task_started, etc.)
   - Subscribe to error events
   - Subscribe to question events
   - Maintain local state cache

2. **State Tracking**:
   - Track each agent's current state
   - Track state version (for optimistic locking)
   - Track last activity timestamp
   - Track error history (last N errors)

3. **Connection Management**:
   - Auto-reconnect on disconnect
   - Detect stale connection
   - Report connection health

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | File exists | `test -f agents/monitoring/event-bus-listener.ts` returns 0 |
| 2 | Exports EventBusListener | `grep -q "export class EventBusListener" agents/monitoring/event-bus-listener.ts` returns 0 |
| 3 | Has connect method | `grep -q "connect(" agents/monitoring/event-bus-listener.ts` returns 0 |
| 4 | Has getCurrentState method | `grep -q "getCurrentState" agents/monitoring/event-bus-listener.ts` returns 0 |
| 5 | Tracks agent states | `grep -q "agentStates" agents/monitoring/event-bus-listener.ts` returns 0 |
| 6 | Has version tracking | `grep -q "stateVersion" agents/monitoring/event-bus-listener.ts` returns 0 |
| 7 | TypeScript compiles | `npx tsc --noEmit agents/monitoring/event-bus-listener.ts` returns 0 |
| 8 | Unit tests pass | `npm test -- --grep "event-bus-listener"` passes |

**FAIL** if any criterion is not met.

---

## Output Files

```
agents/monitoring/
└── event-bus-listener.ts
```

---

## Code Template

```typescript
// agents/monitoring/event-bus-listener.ts

import { EventBus, Event, EventType } from '../../server/orchestration/event-bus';

export interface AgentState {
  agentId: string;
  agentType: string;
  status: 'idle' | 'working' | 'blocked' | 'error';
  currentTask?: string;
  progress?: number;
  stateVersion: number;
  lastActivity: Date;
  errorHistory: ErrorRecord[];
}

interface ErrorRecord {
  message: string;
  timestamp: Date;
  taskId?: string;
}

export class EventBusListener {
  private eventBus: EventBus;
  private agentStates: Map<string, AgentState> = new Map();
  private connected: boolean = false;

  constructor(eventBus: EventBus) {
    this.eventBus = eventBus;
  }

  async connect(): Promise<void> {
    this.subscribeToEvents();
    this.connected = true;
  }

  async disconnect(): Promise<void> {
    // Unsubscribe from events
    this.connected = false;
  }

  isConnected(): boolean {
    return this.connected;
  }

  getCurrentState(): Map<string, AgentState> {
    return new Map(this.agentStates);
  }

  getAgentState(agentId: string): AgentState | undefined {
    return this.agentStates.get(agentId);
  }

  private subscribeToEvents(): void {
    this.eventBus.subscribe('agent_started', this.handleAgentStarted.bind(this));
    this.eventBus.subscribe('agent_stopped', this.handleAgentStopped.bind(this));
    this.eventBus.subscribe('task_started', this.handleTaskStarted.bind(this));
    this.eventBus.subscribe('task_completed', this.handleTaskCompleted.bind(this));
    this.eventBus.subscribe('task_failed', this.handleTaskFailed.bind(this));
    this.eventBus.subscribe('question_asked', this.handleQuestionAsked.bind(this));
  }

  private handleAgentStarted(event: Event): void {
    const { agentId, agentType } = event.payload as any;
    this.agentStates.set(agentId, {
      agentId,
      agentType,
      status: 'idle',
      stateVersion: 1,
      lastActivity: new Date(),
      errorHistory: [],
    });
  }

  private handleTaskFailed(event: Event): void {
    const { agentId, error, taskId } = event.payload as any;
    const state = this.agentStates.get(agentId);
    if (state) {
      state.status = 'error';
      state.stateVersion++;
      state.lastActivity = new Date();
      state.errorHistory.push({
        message: error,
        timestamp: new Date(),
        taskId,
      });
      // Keep only last 10 errors
      if (state.errorHistory.length > 10) {
        state.errorHistory.shift();
      }
    }
  }

  // ... other handlers
}
```

---

## Validation

```bash
npx tsc --noEmit agents/monitoring/event-bus-listener.ts
npm test -- --grep "event-bus-listener"
```
