# ORC-001: Message Bus Implementation

---

## Metadata

| Field          | Value                     |
| -------------- | ------------------------- |
| **Phase**      | 3 - Orchestration         |
| **Depends On** | BLD-001                   |
| **Blocks**     | ORC-002, ORC-003, WSK-001 |
| **Priority**   | P1                        |
| **Owner**      | Build Agent               |

---

## Summary

Implement in-process message bus for agent-to-agent and agent-to-system communication.

---

## Requirements

1. **Core Bus**:
   - Publish/subscribe pattern
   - Typed event definitions
   - Async event handlers
   - Event ordering guarantees

2. **Event Types**:
   - agent_started, agent_stopped
   - task_started, task_completed, task_failed
   - question_asked, question_answered
   - build_started, build_completed

3. **Features**:
   - Event history (for replay/debugging)
   - Error handling in handlers
   - Handler priority ordering

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion            | How to Verify                                                                 |
| --- | -------------------- | ----------------------------------------------------------------------------- |
| 1   | File exists          | `test -f server/orchestration/event-bus.ts` returns 0                         |
| 2   | Exports EventBus     | `grep -q "export class EventBus" server/orchestration/event-bus.ts` returns 0 |
| 3   | Has publish method   | `grep -q "publish(" server/orchestration/event-bus.ts` returns 0              |
| 4   | Has subscribe method | `grep -q "subscribe(" server/orchestration/event-bus.ts` returns 0            |
| 5   | Has typed events     | `grep -q "type.*Event" server/orchestration/event-bus.ts` returns 0           |
| 6   | Has event history    | `grep -q "history" server/orchestration/event-bus.ts` returns 0               |
| 7   | TypeScript compiles  | `npx tsc --noEmit server/orchestration/event-bus.ts` returns 0                |
| 8   | Unit tests pass      | `npm test -- --grep "event-bus"` passes                                       |

**FAIL** if any criterion is not met.

---

## Output Files

```
server/orchestration/
├── event-bus.ts
└── events.ts
```

---

## Code Template

```typescript
// server/orchestration/event-bus.ts

export type EventType =
  | "agent_started"
  | "agent_stopped"
  | "task_started"
  | "task_completed"
  | "task_failed"
  | "question_asked"
  | "question_answered"
  | "build_started"
  | "build_completed";

export interface Event<T = unknown> {
  type: EventType;
  payload: T;
  timestamp: Date;
  source: string;
}

type EventHandler<T> = (event: Event<T>) => Promise<void>;

export class EventBus {
  private handlers: Map<EventType, EventHandler<unknown>[]> = new Map();
  private history: Event[] = [];

  publish<T>(type: EventType, payload: T, source: string): void {
    // Emit to handlers, store in history
  }

  subscribe<T>(type: EventType, handler: EventHandler<T>): () => void {
    // Register handler, return unsubscribe
  }

  getHistory(type?: EventType): Event[] {
    // Return filtered history
  }
}
```

---

## Validation

```bash
npx tsc --noEmit server/orchestration/event-bus.ts
npm test -- --grep "event-bus"
```
