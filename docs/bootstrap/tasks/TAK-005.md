# TAK-005: Task Blocks Migration

---

## Metadata

| Field | Value |
|-------|-------|
| **Phase** | 1 - Database Schema |
| **Depends On** | TAK-001 |
| **Blocks** | TAK-008 (ValidationGate) |
| **Priority** | P1 |
| **Owner** | Build Agent |

---

## Summary

Create the task_blocks table for tracking blocking reasons. Supports validation blocks, dependency blocks, manual blocks, and ambiguity blocks.

---

## Requirements

1. **Create task_blocks table**:
   - task_id reference
   - block_type: validation, dependency, manual, ambiguous, missing_tests
   - reason text
   - blocking_entity_id (for dependency blocks)
   - severity: error, warning
   - Resolution tracking: resolved_at, resolved_by, resolution_notes

2. **Create indexes**:
   - idx_blocks_task on task_id
   - idx_blocks_unresolved partial index for unresolved blocks

---

## Pass Criteria

**PASS** when ALL of the following are true:

| # | Criterion | How to Verify |
|---|-----------|---------------|
| 1 | Migration file exists | `test -f database/migrations/054_task_blocks.sql` returns 0 |
| 2 | Has table | `grep -q "CREATE TABLE IF NOT EXISTS task_blocks" database/migrations/054_task_blocks.sql` returns 0 |
| 3 | Has block types | `grep -q "validation.*dependency.*manual.*ambiguous" database/migrations/054_task_blocks.sql` returns 0 |
| 4 | Has resolution columns | `grep -q "resolved_at.*resolved_by" database/migrations/054_task_blocks.sql` returns 0 |
| 5 | Migration runs | `sqlite3 :memory: < database/migrations/054_task_blocks.sql && echo 'OK'` returns "OK" |

**FAIL** if any criterion is not met.

---

## Output Files

```
database/migrations/
└── 054_task_blocks.sql
```

---

## Code Template

```sql
-- Migration 054: Task blocks

CREATE TABLE IF NOT EXISTS task_blocks (
  id TEXT PRIMARY KEY,
  task_id TEXT NOT NULL,
  block_type TEXT NOT NULL CHECK (block_type IN
    ('validation', 'dependency', 'manual', 'ambiguous', 'missing_tests')),
  reason TEXT NOT NULL,
  blocking_entity_id TEXT,
  severity TEXT NOT NULL DEFAULT 'error',
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  resolved_at TEXT,
  resolved_by TEXT,
  resolution_notes TEXT
);

CREATE INDEX IF NOT EXISTS idx_blocks_task ON task_blocks(task_id);
CREATE INDEX IF NOT EXISTS idx_blocks_unresolved ON task_blocks(task_id)
  WHERE resolved_at IS NULL;
```

---

## Validation

```bash
npm run migrate
sqlite3 database/ideas.db ".schema task_blocks"
```

---

## Next Steps

After completing: Create validation_rules table (TAK-006).
