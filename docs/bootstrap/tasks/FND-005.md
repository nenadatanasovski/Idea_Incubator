# FND-005: Test Infrastructure Setup

---

## Metadata

| Field          | Value               |
| -------------- | ------------------- |
| **Phase**      | 1 - Foundation      |
| **Depends On** | FND-002             |
| **Blocks**     | All agent testing   |
| **Priority**   | P2                  |
| **Owner**      | Human + Claude Code |

---

## Summary

Set up comprehensive test infrastructure including unit tests, integration tests, and E2E tests. Configure Vitest for fast execution, create test utilities, and establish testing conventions.

---

## Context

### Testing Strategy

| Test Type       | Purpose                   | Speed      | Coverage |
| --------------- | ------------------------- | ---------- | -------- |
| **Unit**        | Test individual functions | Fast (ms)  | High     |
| **Integration** | Test API endpoints        | Medium (s) | Medium   |
| **E2E**         | Test full workflows       | Slow (min) | Low      |

### Test Stack

| Tool          | Purpose                        |
| ------------- | ------------------------------ |
| **Vitest**    | Test runner (fast, ESM-native) |
| **supertest** | HTTP request testing           |
| **msw**       | API mocking                    |
| **ts-node**   | TypeScript execution           |

---

## Requirements

1. **Vitest Configuration**:
   - Configure for TypeScript
   - Set up code coverage reporting
   - Configure test patterns

2. **Test Utilities**:
   - Database test helpers (setup/teardown)
   - API test client
   - Mock factories for common entities

3. **Testing Conventions**:
   - File naming: `*.test.ts`
   - Test structure: describe/it/expect
   - Assertions: use Vitest's expect

4. **CI Integration**:
   - Tests run on every commit
   - Coverage thresholds enforced
   - Parallel test execution

---

## Pass Criteria

**PASS** when ALL of the following are true:

| #   | Criterion                | How to Verify                        |
| --- | ------------------------ | ------------------------------------ |
| 1   | Vitest configured        | `npm test` runs tests                |
| 2   | Test utilities exist     | Files in `tests/helpers/`            |
| 3   | Example tests pass       | At least 5 unit tests pass           |
| 4   | Coverage reporting works | `npm run test:coverage` shows report |

**FAIL** if any criterion is not met.

---

## Output Files

```
vitest.config.ts                 <- Vitest configuration
tests/helpers/db.ts              <- Database test helpers
tests/helpers/api.ts             <- API test helpers
tests/helpers/factories.ts       <- Test data factories
tests/setup.ts                   <- Global test setup
```

---

## Code Template

### Vitest Config

```typescript
// vitest.config.ts
import { defineConfig } from "vitest/config";

export default defineConfig({
  test: {
    globals: true,
    environment: "node",
    setupFiles: ["./tests/setup.ts"],
    include: ["tests/**/*.test.ts"],
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "html"],
      exclude: ["node_modules", "tests"],
    },
  },
});
```

### Test Helpers

```typescript
// tests/helpers/db.ts
import { query, run } from "../../database/db";

export async function setupTestDb() {
  // Run in-memory database for tests
  process.env.DB_PATH = ":memory:";
  await run("PRAGMA foreign_keys = ON");
}

export async function cleanupTestDb() {
  // Clear all test data
  const tables = await query<{ name: string }>(
    "SELECT name FROM sqlite_master WHERE type='table'",
  );
  for (const table of tables) {
    await run(`DELETE FROM ${table.name}`);
  }
}
```

### Example Test

```typescript
// tests/unit/example.test.ts
import { describe, it, expect, beforeEach } from "vitest";
import { setupTestDb, cleanupTestDb } from "../helpers/db";

describe("Example", () => {
  beforeEach(async () => {
    await setupTestDb();
  });

  afterEach(async () => {
    await cleanupTestDb();
  });

  it("should work correctly", () => {
    expect(1 + 1).toBe(2);
  });
});
```

---

## Validation

```bash
# Run all tests
npm test

# Run with coverage
npm run test:coverage

# Run specific test file
npm test -- tests/unit/example.test.ts

# Watch mode for development
npm test -- --watch
```

---

## Next Steps

After completing: Foundation is complete. Proceed with Unified File System implementation (UFS-\*).
